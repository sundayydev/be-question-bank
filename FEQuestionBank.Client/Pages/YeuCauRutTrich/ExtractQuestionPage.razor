@page "/tools/exam-extract/single"
@using BEQuestionBank.Shared.DTOs.MaTran
@using BeQuestionBank.Shared.DTOs.YeuCauRutTrich
@using BeQuestionBank.Shared.DTOs.MonHoc
@using BeQuestionBank.Shared.DTOs.Phan
@using MudBlazor
@inherits FEQuestionBank.Client.Pages.DeThi.ExtractQuestionPage

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <!-- Progress Stepper -->
    <MudPaper Elevation="2" Class="pa-4 mb-6">
        <MudStepper @ref="_stepper" Linear="false">
            <MudStep Title="Chọn môn học" Icon="@Icons.Material.Filled.School" />
            <MudStep Title="Cấu hình ma trận" Icon="@Icons.Material.Filled.GridOn" />
            <MudStep Title="Xem trước" Icon="@Icons.Material.Filled.Preview" />
            <MudStep Title="Kiểm tra" Icon="@Icons.Material.Filled.CheckCircle" StatusColor="@(_isValidated ? Color.Success : Color.Default)" />
            <MudStep Title="Rút trích" Icon="@Icons.Material.Filled.AutoFixHigh" Disabled="@(!_isValidated)" />
        </MudStepper>
    </MudPaper>

    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">Rút Trích Đề Thi</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Tạo đề thi tự động dựa trên ma trận CLO và loại câu hỏi
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            <MudForm @ref="_form" Model="_model">

                <!-- BƯỚC 1: Chọn Môn học & Chế độ -->
                <MudPaper Elevation="1" Class="pa-4 mb-6">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.LooksOne" Class="mr-2" />
                        Thông tin cơ bản
                    </MudText>
                    
                    <MudGrid Spacing="4">
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Guid"
                                       Label="Môn Học"
                                       Variant="Variant.Outlined"
                                       Value="_model.MaMonHoc"
                                       ValueChanged="@OnMonHocChanged"
                                       Required="true">
                                @foreach (var mh in _monHocs)
                                {
                                    <MudSelectItem Value="@mh.MaMonHoc">
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Small" />
                                            <span>@mh.TenMonHoc</span>
                                        </div>
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect T="bool"
                                       Value="_maTran.CloPerPart"
                                       ValueChanged="@OnCloPerPartChanged"
                                       Variant="Variant.Outlined"
                                       Label="Chế độ rút trích">
                                <MudSelectItem Value="false">
                                    <MudIcon Icon="@Icons.Material.Filled.ViewCompact" Size="Size.Small" Class="mr-1" />
                                    Ma trận CLO x Loại câu hỏi (toàn đề)
                                </MudSelectItem>
                                <MudSelectItem Value="true">
                                    <MudIcon Icon="@Icons.Material.Filled.ViewModule" Size="Size.Small" Class="mr-1" />
                                    Theo từng Chương/Phần
                                </MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-4" />

                    <MudGrid Spacing="4">
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_model.NoiDungRutTrich"
                                          Label="Nội dung rút trích"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          Placeholder="Ví dụ: Đề thi giữa kỳ - Học kỳ 1 - 2024"/>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_model.GhiChu"
                                          Label="Ghi chú"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          Placeholder="Ghi chú thêm (nếu có)"/>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <!-- Chọn phần (chỉ khi CloPerPart = true) -->
                @if (_maTran.CloPerPart)
                {
                    <MudPaper Elevation="1" Class="pa-4 mb-6">
                        <MudText Typo="Typo.h6" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-2" />
                            Chọn các Chương/Phần để rút trích
                        </MudText>

                        @if (_availableParts.Any())
                        {
                            <MudSelect T="Guid"
                                       MultiSelection="true"
                                       Dense="false"
                                       Variant="Variant.Outlined"
                                       AnchorOrigin="Origin.BottomCenter"
                                       TransformOrigin="Origin.TopCenter"
                                       SelectedValues="@_selectedPartIds"
                                       SelectedValuesChanged="@OnPartSelectionChanged"
                                       ToStringFunc="@(id => _availableParts.FirstOrDefault(p => p.MaPhan == id)?.TenPhan ?? id.ToString())"
                                       Placeholder="Nhấp để chọn các chương/phần..."
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.FolderOpen"
                                       Style="font-size: 1.1rem;"
                                       Class="mb-4">

                                @foreach (var phan in _availableParts)
                                {
                                    <MudSelectItem Value="@phan.MaPhan">
                                        <div class="d-flex align-center gap-3">
                                            <MudIcon Icon="@Icons.Material.Filled.Topic" Size="Size.Small" />
                                            <span>
                                                @(phan.ThuTu > 0
                                                    ? $"Chương {phan.ThuTu}: {phan.TenPhan}"
                                                    : phan.TenPhan)
                                            </span>
                                        </div>
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            @if (_selectedPartIds.Any())
                            {
                                <MudAlert Severity="Severity.Info" Class="mt-3" Dense="true">
                                    Đã chọn <strong>@_selectedPartIds.Count</strong> chương/phần
                                </MudAlert>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">
                                Chọn môn học để hiển thị danh sách chương/phần.
                            </MudAlert>
                        }
                    </MudPaper>
                }

                <MudDivider Class="my-6" />

                <!-- BƯỚC 2: Cấu hình ma trận CLO x Loại câu hỏi -->
                <MudPaper Elevation="1" Class="pa-4 mb-6">
                    <div class="d-flex align-center justify-space-between mb-4">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.LooksTwo" Class="mr-2" />
                            Ma trận CLO × Loại câu hỏi
                        </MudText>

                        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="@ResetPage">
                            Xóa tất cả
                        </MudButton>
                    </div>

                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        <MudText Typo="Typo.body2">
                            <strong>Hướng dẫn đếm câu hỏi:</strong>
                            <br/>
                            • <strong style="color: #ff9800;">NH (Câu hỏi nhóm):</strong> Nhập <u>số nhóm câu hỏi</u>. Tổng = số nhóm × số câu con/nhóm
                            <br/>
                            • <strong style="color: #2196f3;">TL (Tự luận):</strong> Nhập <u>số câu TL cha</u>. Tổng = số câu cha × số câu con/cha
                            <br/>
                            • <strong style="color: #4caf50;">TN, MN, GN, DT:</strong> Mỗi câu tính là <u>1 câu hỏi</u>
                        </MudText>
                    </MudAlert>

                    @* Cấu hình số câu con cho NH và TL *@
                    <MudPaper Elevation="0" Class="pa-3 mb-4" Style="background: #fff8e1; border-radius: 8px;">
                        <MudText Typo="Typo.subtitle2" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Class="mr-2" />
                            Cấu hình số câu con trung bình
                        </MudText>
                        <MudGrid Spacing="3">
                            <MudItem xs="6" sm="3">
                                <MudNumericField T="int"
                                                 Label="Số câu con/nhóm (NH)"
                                                 Value="@GetChildQuestionCount("NH")"
                                                 ValueChanged="@(v => SetChildQuestionCount("NH", v))"
                                                 Min="1"
                                                 Max="20"
                                                 Variant="Variant.Outlined"
                                                 Margin="Margin.Dense"
                                                 HelperText="Mỗi nhóm có bao nhiêu câu?" />
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudNumericField T="int"
                                                 Label="Số câu con/TL"
                                                 Value="@GetChildQuestionCount("TL")"
                                                 ValueChanged="@(v => SetChildQuestionCount("TL", v))"
                                                 Min="1"
                                                 Max="20"
                                                 Variant="Variant.Outlined"
                                                 Margin="Margin.Dense"
                                                 HelperText="Mỗi câu TL có bao nhiêu phần?" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>

                    @* Chế độ toàn đề - Ma trận CLO x Loại câu hỏi *@
                    @if (!_maTran.CloPerPart)
                    {
                        <MudPaper Elevation="2" Class="pa-4">
                            <!-- Nút thêm CLO -->
                            <div class="d-flex justify-space-between align-center mb-4">
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.GridOn" Size="Size.Small" Class="mr-2" />
                                    Ma trận rút trích
                                </MudText>
                                <div class="d-flex gap-2">
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="AddClo">
                                        Thêm CLO
                                    </MudButton>
                                </div>
                            </div>

                            <!-- Bảng ma trận -->
                            <MudSimpleTable Hover="true" Dense="true" Style="overflow-x: auto;" Elevation="0" Class="matrix-table">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #1976d2, #42a5f5);">
                                        <th style="color: white; font-weight: bold; min-width: 200px; padding: 12px;">Loại câu hỏi</th>
                                        @foreach (var clo in _matrixClos)
                                        {
                                            <th style="color: white; font-weight: bold; text-align: center; min-width: 120px; padding: 12px;">
                                                <div class="d-flex flex-column align-center">
                                                    <span>CLO @clo</span>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                                                   Size="Size.Small" 
                                                                   Color="Color.Inherit"
                                                                   OnClick="@(() => RemoveCloCloumn(clo))"
                                                                   Style="opacity: 0.7;" />
                                                </div>
                                            </th>
                                        }
                                        <th style="color: white; font-weight: bold; text-align: center; padding: 12px;">Tổng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var loai in _questionTypes)
                                    {
                                        <tr>
                                            <td style="font-weight: 600; padding: 12px;">
                                                <div class="d-flex align-center gap-2">
                                                    <MudChip T="string" 
                                                             Size="Size.Small" 
                                                             Color="@GetQuestionTypeColor(loai.Key)"
                                                             Variant="Variant.Filled">
                                                        @loai.Key
                                                    </MudChip>
                                                    <span>@loai.Value</span>
                                                    <MudTooltip Text="@GetQuestionTypeTooltip(loai.Key)">
                                                        <MudIcon Icon="@Icons.Material.Filled.Info" 
                                                                 Size="Size.Small" 
                                                                 Color="@GetQuestionTypeInfoColor(loai.Key)"
                                                                 Style="cursor: help;" />
                                                    </MudTooltip>
                                                    @if (IsCountingChildQuestions(loai.Key))
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                                            ×@GetChildQuestionCount(loai.Key) câu con
                                                        </MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                                            1 câu = 1
                                                        </MudChip>
                                                    }
                                                </div>
                                            </td>
                                            @foreach (var clo in _matrixClos)
                                            {
                                                <td style="text-align: center; padding: 8px;">
                                                    <MudNumericField T="int"
                                                                     Value="@GetMatrixValue(clo, loai.Key)"
                                                                     ValueChanged="@(v => SetMatrixValue(clo, loai.Key, v))"
                                                                     Min="0"
                                                                     Variant="Variant.Outlined"
                                                                     Margin="Margin.Dense"
                                                                     Style="width: 80px; margin: 0 auto;"
                                                                     HideSpinButtons="true" />
                                                </td>
                                            }
                                            <td style="text-align: center; padding: 12px; font-weight: bold; background: #f5f5f5;">
                                                @{
                                                    var rawRowTotal = GetRowTotal(loai.Key);
                                                    var realRowTotal = GetRowTotalWithChildren(loai.Key);
                                                }
                                                @if (rawRowTotal != realRowTotal)
                                                {
                                                    <div class="d-flex flex-column align-center">
                                                        <span>@rawRowTotal</span>
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled" Style="font-size: 0.7rem;">
                                                            = @realRowTotal câu
                                                        </MudChip>
                                                    </div>
                                                }
                                                else
                                                {
                                                    @rawRowTotal
                                                }
                                            </td>
                                        </tr>
                                    }
                                    <!-- Tổng cột -->
                                    <tr style="background: #e3f2fd; font-weight: bold;">
                                        <td style="padding: 12px;">Tổng theo CLO</td>
                                        @foreach (var clo in _matrixClos)
                                        {
                                            <td style="text-align: center; padding: 12px;">
                                                @GetColumnTotal(clo)
                                            </td>
                                        }
                                        <td style="text-align: center; padding: 12px; background: #1976d2; color: white; font-size: 1.1rem;">
                                            @GetGrandTotal()
                                        </td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>

                            <!-- Tổng số câu hỏi -->
                            <div class="d-flex justify-space-between align-center mt-4 pa-3" style="background: #fff3e0; border-radius: 8px;">
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" />
                                    Tổng số câu hỏi cần rút trích:
                                </MudText>
                                <div class="d-flex align-center gap-2">
                                    @{
                                        var grandRaw = GetGrandTotal();
                                        var grandReal = GetGrandTotalWithChildren();
                                    }
                                    @if (grandRaw != grandReal)
                                    {
                                        <MudChip T="int" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Medium">
                                            @grandRaw gốc
                                        </MudChip>
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                    }
                                    <MudChip T="int" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large">
                                        @grandReal câu
                                    </MudChip>
                                </div>
                            </div>
                            
                            <!-- So sánh với số lượng mong đợi -->
                            @if (_expectedTotalQuestions.HasValue)
                            {
                                var total = GetGrandTotalWithChildren();
                                var expected = _expectedTotalQuestions.Value;
                                var isMatch = total == expected;
                                var difference = total - expected;
                                
                                <MudAlert Severity="@(isMatch ? Severity.Success : Severity.Warning)" 
                                          Dense="true" Class="mt-3"
                                          Style="border-radius: 8px;">
                                    @if (isMatch)
                                    {
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            ✅ Khớp với số lượng mong đợi: @expected câu
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            ⚠️ Không khớp với số lượng mong đợi!
                                        </MudText>
                                        <MudText Typo="Typo.body2" Class="mt-1">
                                            Mong đợi: <strong>@expected</strong> | Thực tế: <strong>@total</strong> 
                                            | Chênh lệch: <strong>@(difference > 0 ? "+" : "")@difference</strong>
                                        </MudText>
                                    }
                                </MudAlert>
                            }
                        </MudPaper>
                    }
                    @* Chế độ theo phần/chương *@
                    else
                    {
                        @if (!_selectedPartIds.Any())
                        {
                            <MudAlert Severity="Severity.Warning" Class="mt-4">
                                Vui lòng chọn ít nhất một chương/phần ở trên để cấu hình chi tiết.
                            </MudAlert>
                        }
                        else
                        {
                            <MudTabs Elevation="2" Rounded ApplyEffectsToContainer PanelClass="pa-4">
                                @foreach (var part in _maTran.Parts)
                                {
                                    var phanInfo = _availableParts.FirstOrDefault(p => p.MaPhan == part.MaPhan);
                                    var tenPhanHienThi = phanInfo != null
                                        ? (phanInfo.ThuTu > 0
                                            ? $"Chương {phanInfo.ThuTu}: {phanInfo.TenPhan}"
                                            : phanInfo.TenPhan)
                                        : "Phần không xác định";

                                    <MudTabPanel>
                                        <TabContent>
                                            <div class="d-flex align-center gap-3">
                                                <MudIcon Icon="@Icons.Material.Filled.Topic" Size="Size.Small" />
                                                <MudText Typo="Typo.subtitle1">@tenPhanHienThi</MudText>
                                                @{
                                                    var partRaw = GetPartTotal(part);
                                                    var partReal = GetPartTotalWithChildren(part);
                                                }
                                                @if (partRaw != partReal)
                                                {
                                                    <MudChip T="int" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                                        @partRaw → @partReal câu
                                                    </MudChip>
                                                }
                                                else
                                                {
                                                    <MudChip T="int" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                                                        @partReal câu
                                                    </MudChip>
                                                }
                                            </div>
                                        </TabContent>

                                        <ChildContent>
                                            <MudPaper Elevation="0" Class="pa-4">
                                                <!-- Nút thêm CLO cho phần này -->
                                                <div class="d-flex justify-space-between align-center mb-4">
                                                    <MudText Typo="Typo.subtitle2">
                                                        Ma trận CLO × Loại câu hỏi cho @tenPhanHienThi
                                                    </MudText>
                                                    <MudButton Variant="Variant.Outlined"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Add"
                                                               OnClick="@(() => AddPartClo(part))">
                                                        Thêm CLO
                                                    </MudButton>
                                                </div>

                                                <!-- Bảng ma trận cho phần -->
                                                <MudSimpleTable Hover="true" Dense="true" Style="overflow-x: auto;" Elevation="0">
                                                    <thead>
                                                        <tr style="background: linear-gradient(135deg, #388e3c, #66bb6a);">
                                                            <th style="color: white; font-weight: bold; min-width: 200px; padding: 12px;">Loại câu hỏi</th>
                                                            @foreach (var clo in GetPartClos(part))
                                                            {
                                                                <th style="color: white; font-weight: bold; text-align: center; min-width: 120px; padding: 12px;">
                                                                    <div class="d-flex flex-column align-center">
                                                                        <span>CLO @clo</span>
                                                                        <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                                                                       Size="Size.Small" 
                                                                                       Color="Color.Inherit"
                                                                                       OnClick="@(() => RemovePartClo(part, clo))"
                                                                                       Style="opacity: 0.7;" />
                                                                    </div>
                                                                </th>
                                                            }
                                                            <th style="color: white; font-weight: bold; text-align: center; padding: 12px;">Tổng</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var loai in _questionTypes)
                                                        {
                                                            <tr>
                                                                <td style="font-weight: 600; padding: 12px;">
                                                                    <div class="d-flex align-center gap-2">
                                                                        <MudChip T="string" 
                                                                                 Size="Size.Small" 
                                                                                 Color="@GetQuestionTypeColor(loai.Key)"
                                                                                 Variant="Variant.Filled">
                                                                            @loai.Key
                                                                        </MudChip>
                                                                        <span>@loai.Value</span>
                                                                        @if (IsCountingChildQuestions(loai.Key))
                                                                        {
                                                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">
                                                                                ×@GetChildQuestionCount(loai.Key) câu con
                                                                            </MudChip>
                                                                        }
                                                                        else
                                                                        {
                                                                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                                                                1 câu = 1
                                                                            </MudChip>
                                                                        }
                                                                    </div>
                                                                </td>
                                                                @foreach (var clo in GetPartClos(part))
                                                                {
                                                                    <td style="text-align: center; padding: 8px;">
                                                                        <MudNumericField T="int"
                                                                                         Value="@GetPartMatrixValue(part, clo, loai.Key)"
                                                                                         ValueChanged="@(v => SetPartMatrixValue(part, clo, loai.Key, v))"
                                                                                         Min="0"
                                                                                         Variant="Variant.Outlined"
                                                                                         Margin="Margin.Dense"
                                                                                         Style="width: 80px; margin: 0 auto;"
                                                                                         HideSpinButtons="true" />
                                                                    </td>
                                                                }
                                                                <td style="text-align: center; padding: 12px; font-weight: bold; background: #f5f5f5;">
                                                                    @{
                                                                        var partRowRaw = GetPartRowTotal(part, loai.Key);
                                                                        var partRowReal = GetPartRowTotalWithChildren(part, loai.Key);
                                                                    }
                                                                    @if (partRowRaw != partRowReal)
                                                                    {
                                                                        <div class="d-flex flex-column align-center">
                                                                            <span>@partRowRaw</span>
                                                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled" Style="font-size: 0.7rem;">
                                                                                = @partRowReal câu
                                                                            </MudChip>
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        @partRowRaw
                                                                    }
                                                                </td>
                                                            </tr>
                                                        }
                                                        <!-- Tổng cột -->
                                                        <tr style="background: #e8f5e9; font-weight: bold;">
                                                            <td style="padding: 12px;">Tổng theo CLO</td>
                                                            @foreach (var clo in GetPartClos(part))
                                                            {
                                                                <td style="text-align: center; padding: 12px;">
                                                                    @GetPartColumnTotal(part, clo)
                                                                </td>
                                                            }
                                                            <td style="text-align: center; padding: 12px; background: #388e3c; color: white; font-size: 1.1rem;">
                                                                @{
                                                                    var totalRaw = GetPartTotal(part);
                                                                    var totalReal = GetPartTotalWithChildren(part);
                                                                }
                                                                @if (totalRaw != totalReal)
                                                                {
                                                                    <div class="d-flex flex-column align-center">
                                                                        <span>@totalRaw</span>
                                                                        <span style="font-size: 0.75rem;">→ @totalReal câu</span>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    @totalRaw
                                                                }
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </MudSimpleTable>

                                                <div class="mt-4">
                                                    <MudButton Color="Color.Error"
                                                               Variant="Variant.Text"
                                                               StartIcon="@Icons.Material.Filled.RemoveCircle"
                                                               OnClick="@(() => RemovePart(part))">
                                                        Xóa chương này khỏi ma trận
                                                    </MudButton>
                                                </div>
                                            </MudPaper>
                                        </ChildContent>
                                    </MudTabPanel>
                                }
                            </MudTabs>

                            <!-- Tổng tất cả các phần -->
                            <div class="d-flex justify-space-between align-center mt-4 pa-3" style="background: #e8f5e9; border-radius: 8px;">
                                <MudText Typo="Typo.subtitle1">
                                    <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" />
                                    Tổng số câu hỏi tất cả các chương:
                                </MudText>
                                <div class="d-flex align-center gap-2">
                                    @{
                                        var allPartsRaw = GetAllPartsTotal();
                                        var allPartsReal = GetAllPartsTotalWithChildren();
                                    }
                                    @if (allPartsRaw != allPartsReal)
                                    {
                                        <MudChip T="int" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Medium">
                                            @allPartsRaw gốc
                                        </MudChip>
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                    }
                                    <MudChip T="int" Color="Color.Success" Variant="Variant.Filled" Size="Size.Large">
                                        @allPartsReal câu
                                    </MudChip>
                                </div>
                            </div>
                            
                            <!-- So sánh với số lượng mong đợi -->
                            @if (_expectedTotalQuestions.HasValue)
                            {
                                var total = GetAllPartsTotalWithChildren();
                                var expected = _expectedTotalQuestions.Value;
                                var isMatch = total == expected;
                                var difference = total - expected;
                                
                                <MudAlert Severity="@(isMatch ? Severity.Success : Severity.Warning)" 
                                          Dense="true" Class="mt-3"
                                          Style="border-radius: 8px;">
                                    @if (isMatch)
                                    {
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            ✅ Khớp với số lượng mong đợi: @expected câu
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                            ⚠️ Không khớp với số lượng mong đợi!
                                        </MudText>
                                        <MudText Typo="Typo.body2" Class="mt-1">
                                            Mong đợi: <strong>@expected</strong> | Thực tế: <strong>@total</strong> 
                                            | Chênh lệch: <strong>@(difference > 0 ? "+" : "")@difference</strong>
                                        </MudText>
                                    }
                                </MudAlert>
                            }
                        }
                    }
                </MudPaper>

                <!-- Thông báo trạng thái validation -->
                @if (_isValidated)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4" Icon="@Icons.Material.Filled.CheckCircle">
                        <strong>✓ Ma trận đã được kiểm tra và hợp lệ!</strong><br/>
                        @_validationMessage<br/>
                        <em>Bạn có thể tiến hành rút trích đề thi ngay bây giờ.</em>
                    </MudAlert>
                }
                else if (!string.IsNullOrEmpty(_validationMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4" Icon="@Icons.Material.Filled.Error">
                        <strong> Ma trận chưa hợp lệ</strong><br/>
                        @_validationMessage
                    </MudAlert>
                }

                <!-- BƯỚC 3-6: Các nút hành động -->
                <MudPaper Elevation="2" Class="pa-4">
                    <div class="d-flex flex-wrap justify-end gap-3">
                        <!-- Bước 3: Xem trước -->
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Info"
                                   OnClick="XemTruocMaTran"
                                   Disabled="@(_model.MaMonHoc == Guid.Empty)">
                            <MudIcon Icon="@Icons.Material.Filled.Looks3" Size="Size.Small" Class="mr-1" />
                            Xem trước ma trận
                        </MudButton>

                        <!-- Bước 4: Kiểm tra -->
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Warning"
                                   OnClick="KiemTraMaTran"
                                   Disabled="@(_isChecking || _model.MaMonHoc == Guid.Empty)">
                            <MudIcon Icon="@Icons.Material.Filled.Looks4" Size="Size.Small" Class="mr-1" />
                            @(_isChecking ? "Đang kiểm tra..." : "Kiểm tra ma trận")
                        </MudButton>

                        <!-- Bước 6: Rút trích (chỉ khi đã validate) -->
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   OnClick="RutTrichDeThi"
                                   Disabled="@(_isProcessing || !_isValidated)">
                            <MudIcon Icon="@Icons.Material.Filled.Looks5" Size="Size.Small" Class="mr-1" />
                            @(_isProcessing ? "Đang rút trích..." : "Rút trích đề thi")
                        </MudButton>
                    </div>

                    @if (!_isValidated && !string.IsNullOrEmpty(_validationMessage))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Error" Class="mt-2 text-end">
                            * Vui lòng kiểm tra ma trận thành công trước khi rút trích
                        </MudText>
                    }
                </MudPaper>

            </MudForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

<style>
    .matrix-table th, .matrix-table td {
        border: 1px solid #e0e0e0;
    }
    .matrix-table tr:hover {
        background-color: #f5f5f5;
    }
</style>

@code {
    private MudStepper _stepper = default!;
}