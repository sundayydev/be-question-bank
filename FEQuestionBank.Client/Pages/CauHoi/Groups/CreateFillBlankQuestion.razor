@page "/create-question/create-fill-blank"
@page "/create-question/fill-blank/{EditId:guid}"
@inherits CreateFillBlankQuestionBase
@using BeQuestionBank.Shared.Enums
@using BeQuestionBank.Shared.DTOs.CauHoi


<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs"/>
    <div class="question-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <MudIcon Icon="@Icons.Material.Filled.FormatQuote" Size="Size.Large" Style="color: white;"/>
            <div>
                <h1>Tạo câu hỏi điền từ</h1>
                <p> Dùng <code>(1)</code>, <code>(2)</code>... để đánh dấu chỗ trống</p>
            </div>
        </div>
    </div>


    <MudGrid>
        <!-- Cột trái: Nội dung + Đáp án -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-6 rounded-xl">
                <!-- Nội dung câu hỏi -->
                <MudText Typo="Typo.subtitle1" Class="mb-2 font-weight-bold">
                    Nội dung câu hỏi
                    <MudText Color="Color.Error">*</MudText>
                </MudText>
                <MudTextField @bind-Value="NoiDungCha"
                              Placeholder="VD: Thủ đô của Việt Nam là (1)_____. Nước ta có (2)____ tỉnh thành trực thuộc trung ương."
                              Lines="6"
                              Variant="Variant.Outlined"
                              Class="mb-6"
                              Immediate="true"
                              DebounceInterval="400"/>

                <!-- Xem trước -->
                @if (!string.IsNullOrWhiteSpace(NoiDungCha))
                {
                    <MudPaper Class="pa-4 blank-preview mb-6">
                        <strong>Xem trước:</strong><br/>
                        @((MarkupString)RenderPreview())
                    </MudPaper>
                }
                <MudItem xs="12" sm="6">
                    <MudSelect T="short" @bind-Value="CapDo" Label="Cấp độ câu hỏi"
                               Variant="Variant.Outlined" Margin="Margin.Dense">
                        <MudSelectItem Value="@((short)1)">1 - Nhận biết</MudSelectItem>
                        <MudSelectItem Value="@((short)2)">2 - Thông hiểu</MudSelectItem>
                        <MudSelectItem Value="@((short)3)">3 - Vận dụng</MudSelectItem>
                        <MudSelectItem Value="@((short)4)">4 - Vận dụng cao</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudDivider Class="my-8"/>

                <!-- Danh sách đáp án cho từng chỗ trống -->
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6">
                        Đáp án cho các chỗ trống
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">@DetectedBlanks.Count chỗ</MudChip>
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SyncBlanks">
                        Đồng bộ tự động
                    </MudButton>
                </div>

                @if (DetectedBlanks.Count == 0)
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        Chưa phát hiện chỗ trống nào. Hãy dùng <code>(1)</code>, <code>(2)</code>... trong nội dung.
                    </MudAlert>
                }

                @foreach (var answer in CauTraLoi)
                {
                    var index = CauTraLoi.IndexOf(answer) + 1;
                    <MudPaper Class="pa-2 mb-4 rounded-lg" Elevation="2" Style="border-left: 5px solid #2563eb;">
                        <div class="d-flex align-center gap-4">
                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="font-weight-bold">
                                @index
                            </MudAvatar>

                            <div class="flex-grow-1">
                                <MudTextField @bind-Value="answer.NoiDung"
                                              Label="@($"Đáp án đúng cho chỗ trống ({index})")"
                                              Placeholder="VD: Hà Nội"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              Style="max-height: 50px"
                                              Class="mb-3"/>
                            </div>
                            <MudCheckBox
                                @bind-Value="answer.HoanVi"
                                Color="Color.Primary"
                                Label="Hoán vị"
                            />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="() => CauTraLoi.Remove(answer)"
                                           Disabled="@(CauTraLoi.Count <= 1)"/>
                        </div>
                    </MudPaper>
                }

                <MudButton StartIcon="@Icons.Material.Filled.AddCircle"
                           Color="Color.Success"
                           Variant="Variant.Outlined"
                           OnClick="() => CauTraLoi.Add(new FillBlankAnswer())">
                    Thêm chỗ trống thủ công
                </MudButton>
                <MudAlert Severity="Severity.Info" Class="mb-4 mt-5">
                    Câu hỏi điền từ mặc định sẽ hoán vị
                </MudAlert>
            </MudPaper>

        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="p-5 rounded-xl shadow-sm position-sticky" Style="top: 55px; background:#fff;">
                <MudText Typo="Typo.h6" Class="mb-4 font-bold" Color="Color.Dark">Cấu hình</MudText>

                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Khoa quản lý</MudText>
                        <MudSelect T="Guid ?" Value="SelectedKhoaId" ValueChanged="OnKhoaChanged"
                                   Placeholder="-- Chọn khoa --" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Khoas)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaKhoa)">@item.TenKhoa</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Môn học</MudText>
                        <MudSelect T="Guid ?" Value="SelectedMonHocId" ValueChanged="OnMonHocChanged"
                                   Placeholder="-- Chọn môn --" Variant="Variant.Outlined"
                                   Disabled="@(SelectedKhoaId == null)" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in MonHocs)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaMonHoc)">@item.TenMonHoc</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chương / Phần</MudText>
                        <MudSelect T="Guid ?" @bind-Value="SelectedPhanId"
                                   Placeholder="-- Chọn chương --" Variant="Variant.Outlined"
                                   Disabled="@(SelectedMonHocId == null)" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Phans)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaPhan)">@item.TenPhan</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chuẩn đầu ra (CLO)</MudText>
                        <MudSelect T="EnumCLO" @bind-Value="SelectedCLO" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var clo in CLOs)
                            {
                                <MudSelectItem Value="@clo">@clo</MudSelectItem>
                            }
                        </MudSelect>
                    </div>
                </MudStack>

                <MudDivider Class="my-5"/>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               OnClick="PreviewQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Visibility">
                        Xem trước
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Save">
                        Lưu
                    </MudButton>
                </MudStack>

                <div class="mt-3 d-flex justify-center">
                    <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="GoBack" Size="Size.Small">Hủy bỏ &
                        Quay lại
                    </MudButton>
                </div>

            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .blank-preview {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        border-left: 5px solid #2563eb;
        font-size: 1.1rem;
        line-height: 2rem;
    }

    .question-header {
        background: #0a53be;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 5px;
        box-shadow: 0 4px 20px rgba(30, 64, 175, 0.15);
    }

    .question-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
        color: white;
    }

    .question-header p {
        margin: 0.5rem 0 0 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
    }
</style>