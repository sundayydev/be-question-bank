@page "/create-question/group"
@page "/create-question/group/{EditId:guid}"
@using BeQuestionBank.Shared.Enums
@inherits CreateGroupQuestionBase

<style>
    .answer-row {
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .answer-row:hover {
        background-color: #f5f5f5 !important;
        border-color: #e0e0e0;
    }

    .question-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 5px;
        box-shadow: 0 4px 20px rgba(30, 64, 175, 0.15);
    }

    .question-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
        color: white;
    }

    .question-header p {
        margin: 0.5rem 0 0 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
    }

    .child-question-panel {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 12px;
        transition: all 0.2s;
    }

    .parent-content-box {
        background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudBreadcrumbs Items="_breadcrumbs"/>

    <div class="question-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Large" Style="color: white;"/>
            <div>
                <h1>Tạo câu hỏi nhóm</h1>
                <p>Nhập đoạn văn chung và tạo các câu hỏi liên quan để kiểm tra khả năng đọc hiểu</p>
            </div>
        </div>
    </div>

    <MudGrid>
        <!-- Main Content Area (Left) -->
        <MudItem xs="12" md="8" Style="display: flex; flex-direction: column;">
            <MudStack Spacing="1">
                <MudPaper Class="p-5 rounded-lg shadow-sm">
                <MudText Typo="Typo.subtitle1" Class="font-bold mb-1 d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1"/>
                    Nội dung đoạn văn / Ngữ cảnh chung
                </MudText>
                    <MudText Typo="Typo.caption" Class="text-secondary">
                    Nhập văn bản, đoạn văn hoặc tình huống làm cơ sở cho các câu hỏi con
                </MudText>

                    <MudTextField @bind-Value="NoiDungCha"
                              Placeholder="Ví dụ: Một đoạn văn về lịch sử, một bài đọc tiếng Anh, một tình huống kinh doanh..."
                              Lines="8"
                              FullWidth="true"
                              Variant="Variant.Outlined"
                                  Class="mb-2 bg-white"/>
                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                        <MudSelect T="short" @bind-Value="CapDo" Label="Cấp độ câu hỏi" Variant="Variant.Outlined"
                                   Dense="true" Margin="Margin.Dense">
                            <MudSelectItem Value="@((short)1)">1 - Nhận biết</MudSelectItem>
                            <MudSelectItem Value="@((short)2)">2 - Thông hiểu</MudSelectItem>
                            <MudSelectItem Value="@((short)3)">3 - Vận dụng</MudSelectItem>
                            <MudSelectItem Value="@((short)4)">4 - Vận dụng cao</MudSelectItem>
                        </MudSelect>
                    </MudItem>
            </MudPaper>

                <MudPaper Class="p-5 rounded-lg shadow-sm">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.subtitle1" Class="font-bold d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Class="mr-1"/>
                        Danh sách câu hỏi con
                        <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                 Class="ml-2">@ChildQuestions.Count câu
                        </MudChip>
                    </MudText>

                    <MudTooltip Text="Thêm câu hỏi con mới">
                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                       Color="Color.Primary"
                                       OnClick="AddChildQuestion"/>
                    </MudTooltip>
                </div>

                @if (ChildQuestions.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="my-4">
                        <MudText>Chưa có câu hỏi con nào. Hãy bấm nút <strong>Thêm câu hỏi</strong> để bắt đầu.
                        </MudText>
                    </MudAlert>
                }
                else
                {
                    <MudPaper Elevation="0" Style="max-height:550px; overflow-y:auto; padding:4px;">
                        <MudExpansionPanels MultiExpansion="true">
                            @for (int i = 0; i < ChildQuestions.Count; i++)
                            {
                                var index = i;
                                var question = ChildQuestions[i];
                                var questionPreview = string.IsNullOrEmpty(question.NoiDung)
                                    ? "(Chưa nhập nội dung)"
                                    : (question.NoiDung.Length > 60 ? question.NoiDung.Substring(0, 60) + "..." : question.NoiDung);

                                <MudExpansionPanel Class="child-question-panel">
                                    <TitleContent>
                                        <div class="d-flex align-center w-100">
                                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-3">
                                                @(index + 1)
                                            </MudAvatar>
                                            <div class="flex-grow-1">
                                                <MudText Typo="Typo.caption"
                                                         Class="text-secondary">@questionPreview</MudText>
                                            </div>
                                            <MudCheckBox
                                                @bind-Value="ChildQuestions[index].HoanVi"
                                                Color="Color.Primary"
                                                Label="Hoán vị"/>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@((e) => RemoveChildQuestion(question))"
                                                           Title="Xóa câu này"/>
                                        </div>
                                    </TitleContent>
                                    <ChildContent>
                                        <div class="p-3" style="background-color: #fafafa;">
                                            <div class="mb-3">
                                                <MudText Typo="Typo.caption" Class="mb-1 font-bold">
                                                    Nội dung câu hỏi <span class="text-error">*</span>
                                                </MudText>
                                                <MudTextField @bind-Value="question.NoiDung"
                                                              Placeholder="Nhập nội dung câu hỏi..."
                                                              Variant="Variant.Outlined"
                                                              Lines="2"
                                                              FullWidth="true"
                                                              Class="bg-white"/>
                                            </div>

                                            <MudDivider Class="my-3"/>

                                            <MudText Typo="Typo.caption" Class="mb-2 font-bold d-flex align-center">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small"
                                                         Class="mr-1"/>
                                                Các đáp án:
                                            </MudText>

                                            @for (int j = 0; j < question.CauTraLois.Count; j++)
                                            {
                                                var ans = question.CauTraLois[j];
                                                var label = (char)('A' + j);

                                                <MudPaper
                                                    Class="@($"d-flex align-center p-2 rounded-lg answer-row mb-2 {(ans.LaDapAn ? "bg-success-lighten-5" : "bg-white")}")"
                                                    Elevation="0">
                                                    <MudTooltip
                                                        Text="@(ans.LaDapAn ? "Đây là đáp án đúng" : "Click để chọn làm đáp án đúng")">
                                                        <MudAvatar
                                                            Color="@(ans.LaDapAn ? Color.Success : Color.Default)"
                                                            Size="Size.Medium"
                                                            Class="cursor-pointer font-bold mr-3"
                                                            @onclick="() => ToggleCorrectAnswer(question, ans)">
                                                            @label
                                                        </MudAvatar>
                                                    </MudTooltip>

                                                    <MudTextField @bind-Value="ans.NoiDung"
                                                                  Placeholder="@($"Nhập nội dung đáp án {label}...")"
                                                                  Variant="Variant.Text"
                                                                  DisableUnderLine="true"
                                                                  Margin="Margin.Dense"
                                                                  Class="flex-grow-1 mr-2"/>
                                                    <MudCheckBox
                                                        @bind-Value="@ans.HoanVi"
                                                        Color="Color.Primary"
                                                        Label="Hoán vị"/>
                                                    <MudTooltip Text="Xóa đáp án này">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                                       Size="Size.Small"
                                                                       Color="Color.Error"
                                                                       OnClick="() => RemoveAnswer(question, ans)"
                                                                       Disabled="@(question.CauTraLois.Count <= 2)"/>
                                                    </MudTooltip>
                                                </MudPaper>
                                            }

                                            <MudButton Variant="Variant.Text"
                                                       Color="Color.Primary"
                                                       StartIcon="@Icons.Material.Filled.Add"
                                                       OnClick="() => AddAnswer(question)"
                                                       Size="Size.Small"
                                                       Class="mt-2">
                                                Thêm đáp án khác
                                            </MudButton>
                                        </div>
                                    </ChildContent>
                                </MudExpansionPanel>
                            }
                        </MudExpansionPanels>
                    </MudPaper>
                }

                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddChildQuestion"
                           Class="mt-3 full-width">
                    Thêm câu hỏi con
                </MudButton>
            </MudPaper>
            </MudStack>
        </MudItem>

        <!-- Configuration Sidebar (Right) -->
        <MudItem xs="12" md="4">
            <MudPaper Class="p-5 rounded-xl shadow-sm position-sticky" Style="top: 55px; background:#fff;">
                <MudText Typo="Typo.h6" Class="mb-4 font-bold" Color="Color.Dark">Cấu hình chung</MudText>

                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Khoa quản lý</MudText>
                        <MudSelect T="Guid?" Value="SelectedKhoaId" ValueChanged="OnKhoaChanged"
                                   Placeholder="-- Chọn khoa --"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Khoas)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaKhoa)">@item.TenKhoa</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Môn học</MudText>
                        <MudSelect T="Guid?" Value="SelectedMonHocId" ValueChanged="OnMonHocChanged"
                                   Placeholder="-- Chọn môn --"
                                   Variant="Variant.Outlined"
                                   Disabled="@(SelectedKhoaId == null)"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in MonHocs)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaMonHoc)">@item.TenMonHoc</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chương / Phần</MudText>
                        <MudSelect T="Guid?" @bind-Value="SelectedPhanId"
                                   Placeholder="-- Chọn chương --"
                                   Variant="Variant.Outlined"
                                   Disabled="@(SelectedMonHocId == null)"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Phans)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaPhan)">@item.TenPhan</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chuẩn đầu ra (CLO) chung</MudText>
                        <MudSelect T="EnumCLO" @bind-Value="SelectedCLO"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var clo in CLOs)
                            {
                                <MudSelectItem Value="@clo">@clo</MudSelectItem>
                            }
                        </MudSelect>
                        <MudText Typo="Typo.caption" Class="mt-1 text-secondary">
                            CLO này áp dụng cho tất cả câu con nếu không chọn riêng
                        </MudText>
                    </div>
                </MudStack>

                <MudDivider Class="my-5"/>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               OnClick="PreviewGroupQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Visibility">
                        Xem trước
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveGroupQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Save">
                        Lưu
                    </MudButton>
                </MudStack>

                <div class="mt-3 d-flex justify-center">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Error"
                               OnClick="GoBack"
                               Size="Size.Small">
                        Hủy bỏ & Quay lại
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>