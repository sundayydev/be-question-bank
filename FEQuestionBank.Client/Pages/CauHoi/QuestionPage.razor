@page "/question/list"
@using FEQuestionBank.Client.Component.InfoCard
@using FEQuestionBank.Client.Component.Other
@inherits QuestionPageBase

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs"/>

    <!-- Info Cards -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <InfoCard Icon="@Icons.Material.Filled.QuestionAnswer" IconColor="Color.Primary" Title="Tổng câu hỏi"
                      Value="@TotalQuestions.ToString()"/>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <InfoCard Icon="@Icons.Material.Filled.Description" IconColor="Color.Success" Title="Tự luận"
                      Value="@EssayCount.ToString()"/>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <InfoCard Icon="@Icons.Material.Filled.CheckBox" IconColor="Color.Info" Title="Trắc nghiệm đơn"
                      Value="@SingleCount.ToString()"/>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <InfoCard Icon="@Icons.Material.Filled.TextFields" IconColor="Color.Warning" Title="Trắc nghiệm nhóm"
                      Value="@GroupCount.ToString()"/>
        </MudItem>
    </MudGrid>

    <!-- Search + Create Button -->
    <div class="d-flex flex-wrap gap-3 mb-2 align-items-center">
        <div class="flex-grow-1">
            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="Tìm kiếm nội dung câu hỏi..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Margin="Margin.Dense"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          Clearable="true"
                          OnKeyDown="@(async (e) =>
                                     {
                                         if (e.Key == "Enter") await ForceSearchNow();
                                     })"
                          Class="rounded-lg"/>
        </div>

        <MudButton Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   Color="Color.Primary"
                   Size="Size.Medium"
                   OnClick="OpenCreateDialog">
            Thêm câu hỏi mới
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="ResetFiltersAsync">
            Làm mới
        </MudButton>

    </div>
    <!-- Thêm ngay sau MudTextField tìm kiếm, trước nút Thêm câu hỏi -->
    <div class="d-flex flex-wrap gap-3 align-center mb-2">
        <MudSelect T="Guid?"
                   Label="Khoa"
                   Value="SelectedKhoaId"
                   ValueChanged="OnKhoaChanged"
                   Placeholder="Tất cả khoa"
                   Dense="true"
                   Margin="Margin.Dense"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   Class="min-width-200">
            @foreach (var khoa in Khoas)
            {
                <MudSelectItem Value="@((Guid?)khoa.MaKhoa)">@khoa.TenKhoa</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="Guid?"
                   Label="Môn học"
                   Value="SelectedMonHocId" ValueChanged="OnMonHocChanged"
                   Placeholder="@(SelectedKhoaId == null ? "Chọn khoa trước" : "Tất cả môn")"
                   Disabled="!SelectedKhoaId.HasValue"
                   Dense="true"
                   Margin="Margin.Dense"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   Class="min-width-200">
            @foreach (var mon in MonHocs)
            {
                <MudSelectItem Value="@((Guid?)mon.MaMonHoc)">@mon.TenMonHoc</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="Guid?"
                   Label="Phần"
                   Value="SelectedPhanId"
                   ValueChanged="OnPhanChanged"
                   Placeholder="@(SelectedMonHocId == null ? "Chọn môn trước" : "Tất cả phần")"
                   Disabled="!SelectedMonHocId.HasValue"
                   Dense="true"
                   Margin="Margin.Dense"
                   Variant="Variant.Outlined"
                   Clearable="true"
                   Class="min-width-200">
            @foreach (var phan in Phans)
            {
                <MudSelectItem Value="@((Guid?)phan.MaPhan)">@phan.TenPhan</MudSelectItem>
            }
        </MudSelect>
    </div>

    <!-- Tabs + bắt sự kiện chuyển tab -->
    <MudTabs Elevation="2"
             Rounded="true"
             ApplyEffectsToContainer="true"
             PanelClass="pa-4"
             ActivePanelIndexChanged="@OnTabChanged">

        <!-- TAB TỰ LUẬN -->
        <MudTabPanel Text="@($"Tự luận")" BadgeColor="Color.Success" BadgeData="@EssayCount">
            <ChildContent>
                <MudTable ServerData="LoadEssayData"
                          @ref="essayTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingEssay"
                          LoadingProgressColor="Color.Info">
                    <HeaderContent>
                        <MudTh Style="width: 30%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Clo</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%;text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%;text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 30%;" DataLabel="Nội dung">
                            <LatexContent Content="@context.NoiDung.Truncate(80)"/>
                        </MudTd>

                        <MudTd Style="width: 10%;text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
                        <MudTd Style="width: 15%;text-align:center">
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Style="width:50px;">
                                @context.CLO
                            </MudChip>
                        </MudTd>

                        <MudTd Style="width: 10%;text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%;text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/question/edit/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Essay"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu hỏi tự luận nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"
                                       InfoFormat="Hiển thị {first_item}-{last_item} của {all_items} mục"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>

        <!-- TAB TRẮC NGHIỆM ĐƠN -->
        <MudTabPanel Text="@($"Câu đơn")" BadgeColor="Color.Info" BadgeData="@SingleCount">
            <ChildContent>
                <MudTable ServerData="LoadSingleData"
                          @ref="singleTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingSingle">
                    <HeaderContent>
                        <MudTh Style="width: 30%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Clo</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%; text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 30%;">@((MarkupString)context.NoiDung?.Truncate(80))</MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
                        <MudTd Style="width: 15%; text-align:center">
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Style="width:50px;">
                                @context.CLO
                            </MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%; text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/question/edit/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Single"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu trắc nghiệm nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>
        <!-- TAB TRẮC NGHIỆM nhiu dap án -->
        <MudTabPanel Text="@($"Nhiều đáp án")" BadgeColor="Color.Info" BadgeData="@MultipleChoiceCount">
            <ChildContent>
                <MudTable ServerData="LoadMultipeChoiceData"
                          @ref="multipleTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingMultiple">
                    <HeaderContent>
                        <MudTh Style="width: 30%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Clo</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%; text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 30%;">@((MarkupString)context.NoiDung?.Truncate(80))</MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
                        <MudTd Style="width: 15%; text-align:center">
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Style="width:50px;">
                                @context.CLO
                            </MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%; text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/question/edit/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Multi"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu trắc nghiệm nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>
        <!-- TAB TRẮC NGHIỆM đien tu -->
        <MudTabPanel Text="@($"Điền từ")" BadgeColor="Color.Info" BadgeData="@FillCount">
            <ChildContent>
                <MudTable ServerData="LoadFillingData"
                          @ref="fillblankTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingFillBlink">
                    <HeaderContent>
                        <MudTh Style="width: 30%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Số đáp án</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%; text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 30%;">@((MarkupString)context.NoiDung?.Truncate(80))</MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
                        <MudTd Style="width: 15%; text-align:center">
                            <MudChip T="string" Size="Size.Small"
                                     Color="Color.Secondary">@(context.SoCauHoiCon)</MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%; text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/create-question/fill-blank/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Fill"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu trắc nghiệm nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>
        <!-- TAB TRẮC NGHIỆM nhóm -->
        <MudTabPanel Text="@($"Câu Nhóm")" BadgeColor="Color.Info" BadgeData="@GroupCount">
            <ChildContent>
                <MudTable ServerData="LoadGroupData"
                          @ref="groupTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingGroup">
                    <HeaderContent>
                        <MudTh Style="width: 20%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Clo</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Số câu con</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%; text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 20%;">@((MarkupString)context.NoiDung?.Truncate(80))</MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
 <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Style="width:50px;">
                                @context.CLO
                            </MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="string" Size="Size.Small"
                                     Color="Color.Secondary">@(context.SoCauHoiCon)</MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%; text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/create-question/group/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Group"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu trắc nghiệm nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>
        <!-- TAB TRẮC NGHIỆM ghép nối -->
        <MudTabPanel Text="@($"Ghép nối")" BadgeColor="Color.Info" BadgeData="@PairingCount">
            <ChildContent>
                <MudTable ServerData="LoadPairingData"
                          @ref="pairingTable"
                          Hover="true" Striped="true" Dense="true"
                          Loading="@LoadingPairing">
                    <HeaderContent>
                        <MudTh Style="width: 30%;">Nội dung</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Cấp độ</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Số câu ghép nối</MudTh>
                        <MudTh Style="width: 10%; text-align:center">Đã dùng</MudTh>
                        <MudTh Style="width: 15%; text-align:center">Ngày tạo</MudTh>
                        <MudTh Style="width: 20%; text-align:center">Thao tác</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="width: 30%;">@((MarkupString)context.NoiDung?.Truncate(80))</MudTd>
                        <MudTd Style="width: 10%; text-align:center">
                            <MudChip T="short" Size="Size.Small" Color="@GetLevelColor(context.CapDo)">
                                Cấp @context.CapDo</MudChip>
                        </MudTd>
                        <MudTd Style="width: 15%; text-align:center">
                            <MudChip T="string" Size="Size.Small"
                                     Color="Color.Secondary">@(context.SoCauHoiCon)</MudChip>
                        </MudTd>
                        <MudTd Style="width: 10%; text-align:center">@context.SoLanDung</MudTd>
                        <MudTd Style="width: 15%; text-align:center">@context.NgayTao?.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd Style="width: 20%; text-align:center">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => Navigation.NavigateTo($"/question/edit/{context.MaCauHoi}"))"/>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDetail(context, "Pairing"))"/>

                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           Disabled="@(context.SoLanDung > 0)"
                                           OnClick="@(() => OnDeleteQuestionAsync(context.MaCauHoi, context.NoiDung, context.SoLanDung))"/>
                        </MudTd>
                    </RowTemplate>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Color="Color.Warning">Không có câu trắc nghiệm nào</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager RowsPerPageString="Hàng mỗi trang"/>
                    </PagerContent>
                </MudTable>
            </ChildContent>
        </MudTabPanel>
    </MudTabs>
</MudContainer>