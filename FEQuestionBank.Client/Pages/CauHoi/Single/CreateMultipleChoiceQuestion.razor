@page "/create-question/create-multiple-choice"
@inherits CreateMultipleChoiceQuestionBase
@using BeQuestionBank.Shared.Enums



<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs"/>

    <div class="question-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Large" Style="color: white;"/>
            <div>
                <h1>Câu hỏi Multiple Choice</h1>
                <p>Nhập nội dung câu hỏi, chọn phân loại, và đánh dấu nhiều đáp án đúng (ít nhất 2)</p>
            </div>
        </div>
    </div>

    <MudGrid>
        <MudItem xs="12" md="8" Style="display: flex; flex-direction: column;">
            <MudPaper Class="p-5 rounded-lg shadow-sm h-100" Style="position: relative;">

                <MudGrid AlignItems="Center" Spacing="2">
                    <!-- Nội dung câu hỏi với icon -->
                    <MudItem xs="12" sm="4" Class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Article" Size="Size.Small" Class="mr-1"/>
                        <MudText Typo="Typo.h6" Class="font-bold mb-0">
                            Nội dung câu hỏi
                        </MudText>
                    </MudItem>
                </MudGrid>


                <MudTextField @bind-Value="NoiDungCha"
                              Placeholder="Nhập nội dung câu hỏi..."
                              Lines="4"
                              FullWidth="true"
                              Variant="Variant.Outlined"
                              Class="mb-4 bg-white mt-4"/>
                <MudGrid AlignItems="Center" Spacing="2">
                    <!-- Select Cấp độ -->
                    <MudItem xs="12" sm="6" Class="d-flex align-center">
                        <MudSelect T="short" @bind-Value="CapDo" Label="Cấp độ câu hỏi" Variant="Variant.Outlined"
                                   Dense="true" Margin="Margin.Dense" Class="w-100">
                            <MudSelectItem Value="@((short)1)">1 - Nhận biết</MudSelectItem>
                            <MudSelectItem Value="@((short)2)">2 - Thông hiểu</MudSelectItem>
                            <MudSelectItem Value="@((short)3)">3 - Vận dụng</MudSelectItem>
                            <MudSelectItem Value="@((short)4)">4 - Vận dụng cao</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4"/>

                <div class="d-flex justify-space-between align-center mb-3">
                    <MudText Typo="Typo.h6" Class="font-bold d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Small" Class="mr-1"/>
                        Danh sách đáp án
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">@CauTraLoi.Count câu
                        </MudChip>
                    </MudText>

                    <MudTooltip Text="Thêm lựa chọn mới">
                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Color="Color.Primary"
                                       OnClick="AddAnswer"/>
                    </MudTooltip>
                </div>

                <MudPaper Elevation="0" Style="max-height:450px; overflow-y:auto; padding:4px;"
                          Class="d-flex flex-column gap-2">

                    @foreach (var item in CauTraLoi.Select((a, i) => new { Answer = a, Index = i }))
                    {
                        var answer = item.Answer;
                        var index = item.Index;
                        var label = (char)('A' + index);

                        <MudPaper @key="answer"
                                  Class="d-flex align-center p-3 rounded-lg answer-row mb-2"
                                  Style="@(answer.LaDapAn ? "border-left: 4px solid #4caf50;" : "")">

                            <MudAvatar Size="Size.Medium" Class="font-bold mr-3">@label</MudAvatar>

                            <MudTextField @bind-Value="answer.NoiDung"
                                          Variant="Variant.Outlined"
                                          Class="flex-grow-1 mr-3"
                                          Placeholder="Nhập nội dung đáp án..."/>

                            <div class="d-flex align-center gap-3">

                                <!-- ĐÁP ÁN ĐÚNG -->
                                <MudCheckBox
                                    @bind-Value="answer.LaDapAn"
                                    Color="Color.Success"
                                    Label="Đúng"
                                />

                                <!-- HOÁN VỊ -->
                                <MudCheckBox
                                    @bind-Value="answer.HoanVi "
                                    Color="Color.Primary"
                                    Label="Hoán vị"
                                />

                                <!-- XÓA -->
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="() => RemoveAnswer(answer)"
                                               Disabled="@(CauTraLoi.Count <= 3)"/>
                            </div>
                        </MudPaper>
                    }
                </MudPaper>


                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddAnswer"
                           Class="mt-2 full-width">
                    Thêm câu trả lời khác
                </MudButton>

            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="p-5 rounded-xl shadow-sm position-sticky" Style="top: 55px; background:#fff;">
                <MudText Typo="Typo.h6" Class="mb-4 font-bold" Color="Color.Dark">Cấu hình</MudText>

                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Khoa quản lý</MudText>
                        <MudSelect T="Guid ?" Value="SelectedKhoaId" ValueChanged="OnKhoaChanged"
                                   Placeholder="-- Chọn khoa --" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Khoas)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaKhoa)">@item.TenKhoa</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Môn học</MudText>
                        <MudSelect T="Guid ?" Value="SelectedMonHocId" ValueChanged="OnMonHocChanged"
                                   Placeholder="-- Chọn môn --" Variant="Variant.Outlined"
                                   Disabled="@(SelectedKhoaId == null)" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in MonHocs)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaMonHoc)">@item.TenMonHoc</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chương / Phần</MudText>
                        <MudSelect T="Guid ?" @bind-Value="SelectedPhanId"
                                   Placeholder="-- Chọn chương --" Variant="Variant.Outlined"
                                   Disabled="@(SelectedMonHocId == null)" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var item in Phans)
                            {
                                <MudSelectItem Value="@((Guid?)item.MaPhan)">@item.TenPhan</MudSelectItem>
                            }
                        </MudSelect>
                    </div>

                    <div>
                        <MudText Typo="Typo.caption" Class="mb-1">Chuẩn đầu ra (CLO)</MudText>
                        <MudSelect T="EnumCLO" @bind-Value="SelectedCLO" Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var clo in CLOs)
                            {
                                <MudSelectItem Value="@clo">@clo</MudSelectItem>
                            }
                        </MudSelect>
                    </div>
                </MudStack>

                <MudDivider Class="my-5"/>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               OnClick="PreviewQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Visibility">
                        Xem trước
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveQuestion"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Save">
                        @(IsEditMode ? "Cập nhật" : "Lưu")
                    </MudButton>
                </MudStack>

                <div class="mt-3 d-flex justify-center">
                    <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="GoBack" Size="Size.Small">Hủy bỏ &
                        Quay lại
                    </MudButton>
                </div>

            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>
<style>
    .answer-row {
        transition: all 0.2s;
        border: 1px solid transparent;
    }

    .answer-row:hover {
        background-color: #f5f5f5 !important;
        border-color: #e0e0e0;
    }

    .question-header {
        background: #0d47a1;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 5px;
        box-shadow: 0 4px 20px rgba(30, 64, 175, 0.15);
    }

    .question-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
        color: white;
    }

    .question-header p {
        margin: 0.5rem 0 0 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
    }
</style>