@using FEQuestionBank.Client.Services.Interface
@using MudBlazor
@inherits ComponentBase

<MudDialog MaxWidth="MaxWidth.Small" Position="DialogPosition.Center">
    <TitleContent>
        <MudStack Row Alignment="Center" Spacing="1">
            <MudIcon Icon="@Icons.Material.Filled.LockReset"
                     Size="Size.Medium"
                     Color="Color.Primary" />
            <MudText Typo="Typo.h5" Class="font-weight-bold">
                Đổi mật khẩu
            </MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        <MudPaper Class="pa-3" Style="max-height: 420px; overflow-y: auto; border-radius: 12px;">
            <MudStack Spacing="3">

                <!-- Mật khẩu hiện tại -->
                <MudTextField @bind-Value="Model.CurrentPassword"
                              Label="Mật khẩu hiện tại"
                              Variant="Variant.Outlined"
                              InputType="@(_showCurrent? InputType.Text: InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showCurrent? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => _showCurrent = !_showCurrent)"
                              Required="true"
                              RequiredError="Vui lòng nhập mật khẩu hiện tại" />

                <!-- Mật khẩu mới -->
                <MudTextField @bind-Value="Model.NewPassword"
                              Label="Mật khẩu mới"
                              Variant="Variant.Outlined"
                              InputType="@(_showNew? InputType.Text: InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showNew? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => _showNew = !_showNew)"
                              HelperText="Ít nhất 6 ký tự"
                              Required="true"
                              RequiredError="Vui lòng nhập mật khẩu mới" />

                <!-- Xác nhận mật khẩu -->
                <MudTextField @bind-Value="Model.ConfirmPassword"
                              Label="Xác nhận mật khẩu mới"
                              Variant="Variant.Outlined"
                              InputType="@(_showConfirm? InputType.Text: InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_showConfirm? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => _showConfirm = !_showConfirm)"
                              Required="true"
                              RequiredError="Vui lòng nhập lại"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidateConfirmPassword))" />

            </MudStack>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <MudStack Row Justify="Justify.FlexEnd" Spacing="2" Class="mt-2">

            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       OnClick="Cancel">
                <MudIcon Icon="@Icons.Material.Filled.Close" Class="me-1" />
                Hủy
            </MudButton>

            <MudButton OnClick="Submit"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                    <span>Đang xử lý...</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="me-1" />
                    <span>Lưu thay đổi</span>
                }
            </MudButton>

        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private IAuthApiClient AuthApi { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    [Parameter] public ChangePasswordModel Model { get; set; } = new();

    public bool IsSubmitting { get; set; } = false;

    private bool _showCurrent;
    private bool _showNew;
    private bool _showConfirm;

    public class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private IEnumerable<string> ValidateConfirmPassword(string confirm)
    {
        if (confirm != Model.NewPassword)
            yield return "Mật khẩu xác nhận không khớp!";
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(Model.CurrentPassword) ||
            string.IsNullOrWhiteSpace(Model.NewPassword) ||
            Model.NewPassword != Model.ConfirmPassword)
            return;

        IsSubmitting = true;
        StateHasChanged();

        try
        {
            var response = await AuthApi.ChangePasswordAsync(Model.CurrentPassword, Model.NewPassword);

            if (response.StatusCode == 200)
            {
                Snackbar.Add("Đổi mật khẩu thành công!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(response.Message ?? "Đổi mật khẩu thất bại", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Lỗi kết nối: " + ex.Message, Severity.Error);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
