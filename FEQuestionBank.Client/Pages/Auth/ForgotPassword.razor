@page "/forgot-password"
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@attribute [AllowAnonymous]

<div class="auth-fullscreen-bg">
    <MudPaper Class="auth-card" Elevation="16">
        <!-- Logo -->
        <div class="text-center mb-6">
            <img src="/images/LogoHutechFull.png" alt="HUTECH Logo" style="height: 82px; width: auto;" />
        </div>

        <!-- Title -->
        <MudText Typo="Typo.h5" Class="auth-title text-center mb-6">
            Quên Mật Khẩu
        </MudText>

        <!-- Form -->
        <MudForm @ref="form" @bind-IsValid="@IsValid">
            @if (Step == 1)
            {
                <!-- Bước 1: Nhập Email -->
                <MudTextField @bind-Value="Email"
                              Label="Email"
                              Variant="Variant.Outlined"
                              Class="mb-4"
                              InputType="InputType.Email"
                              Required="true"
                              RequiredError="Email không được để trống"
                              Validation="@(new Func<string, IEnumerable<string>>(EmailValidator))"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              Placeholder="you@example.com" />
            }
            else if (Step == 2)
            {
                <!-- Bước 2: Nhập OTP -->
                <MudTextField @bind-Value="Otp"
                              Label="Mã OTP"
                              Variant="Variant.Outlined"
                              Class="mb-4"
                              Required="true"
                              RequiredError="Vui lòng nhập mã OTP"
                              MaxLength="6"
                              Placeholder="123456" />
            }
            else if (Step == 3)
            {
                <!-- Bước 3: Mật khẩu mới -->
                <MudTextField @bind-Value="MatKhauMoi"
                              Label="Mật khẩu mới"
                              Variant="Variant.Outlined"
                              Class="mb-4"
                              InputType="@(ShowPassword? InputType.Text: InputType.Password)"
                              Required="true"
                              RequiredError="Mật khẩu không được để trống"
                              MinLength="6"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(ShowPassword? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@TogglePassword"
                              Placeholder="Ít nhất 6 ký tự" />

                <MudTextField @bind-Value="NhapLaiMatKhauMoi"
                              Label="Nhập lại mật khẩu"
                              Variant="Variant.Outlined"
                              Class="mb-4"
                              InputType="@(ShowPassword? InputType.Text: InputType.Password)"
                              Required="true"
                              RequiredError="Vui lòng nhập lại mật khẩu"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidatePasswordMatch))"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(ShowPassword? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@TogglePassword"
                              Placeholder="Nhập lại mật khẩu mới" />
            }

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(Error))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="@(() => Error = null)">
                    @Error
                </MudAlert>
            }

            <!-- Nút hành động -->
            <MudButton FullWidth
                       Class="auth-btn"
                       Disabled="@Loading"
                       OnClick="HandleStep">
                @if (Loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate />
                    <span class="ms-2">@ButtonText...</span>
                }
                else
                {
                    <span>@ButtonText</span>
                }
            </MudButton>

            <!-- Link quay lại -->
            <div class="text-center mt-4">
                <MudLink Href="/login" Class="auth-link">Quay về đăng nhập</MudLink>
            </div>
        </MudForm>
    </MudPaper>
</div>