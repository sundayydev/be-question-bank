@page "/exams/{MaDeThi:guid}"
@using BeQuestionBank.Shared.DTOs.DeThi
@using BEQuestionBank.Shared.DTOs.DeThi
@using FEQuestionBank.Client.Services
@using MudBlazor
@inject IDeThiApiClient DeThiApiClient
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inherits DeThiDetailBase

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs" />
    <div class="d-flex justify-space-between align-center mb-4">
        <MudButton Variant="Variant.Filled" Style=@($"color:{Colors.Blue.Darken3}; border-radius:10px") StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">
            Quay lại danh sách đề thi
        </MudButton>

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled"
                       OnClick="@(()=>OpenExportDialog("word"))"
                       StartIcon="@Icons.Material.Filled.Description"
                       Style=@("color:white; background-color:" + Colors.Blue.Darken3 +
                             "; border-radius:8px; height:42px; width:150px; text-transform:none;")>
                Tải Word
            </MudButton>

            <!-- Nút Tải PDF - màu đỏ -->
            <MudButton Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                       OnClick="@(()=>OpenExportDialog("pdf"))"
                       Style=@("color:white; background-color:" + Colors.Red.Darken3 +
                             "; border-radius:8px; height:42px; width:150px; text-transform:none; margin-left:10px;")>
                Tải PDF
            </MudButton>
        </div>
    </div>

    @if (DeThi == null)
    {
        <MudProgressCircular Indeterminate="true"/>
    }
    else
    {
        <MudGrid Spacing="4">
            <!-- Thông tin đề thi -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3" Style="border-radius: 10px">
                    <MudText Typo="Typo.h6" Class="mb-3" Style=@($"color:{Colors.Red.Darken3};")>
                        Thông tin đề thi
                    </MudText>
                    <MudText><strong>Tên đề:</strong> @DeThi.TenDeThi</MudText>
                    <MudText Class="mt-2"><strong>Môn học:</strong> @DeThi.TenMonHoc</MudText>
                    <MudText Class="mt-2"><strong>Khoa:</strong> @DeThi.TenKhoa</MudText>
                    <MudText Class="mt-2"><strong>Ngày tạo:</strong> @DeThi.NgayTao.ToString("dd/MM/yyyy")</MudText>

                    <MudDivider Class="my-4"/>

                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Cấu trúc phân chương:</MudText>
                    <ul class="pl-4 mt-2">
                        @if (DeThi.ChiTietDeThis?.Any() == true)
                        {
                            foreach (var ct in DeThi.ChiTietDeThis.OrderBy(x => x.ThuTu))
                            {
                                <li>Phần @(ct.ThuTu): @(ct.CauHoi?.MaSoCauHoi ?? ct.ThuTu) câu</li>
                            }
                        }
                        else
                        {
                            <li>Chưa có cấu trúc</li>
                        }
                    </ul>
                </MudPaper>

                <!-- Thống kê -->
                <MudPaper Class="pa-4 mt-4" Elevation="3" Style="border-radius: 10px">
                    <MudText Typo="Typo.h6" Class="mb-3">Thống kê câu hỏi</MudText>
                    <MudText><strong>Tổng số câu hỏi:</strong> @(DeThi.SoCauHoi)</MudText>
                    <MudText><strong>Tổng câu hỏi đơn:</strong> @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon == 0) ?? 0)</MudText>
                    <MudText><strong>Tổng câu hỏi nhóm:</strong> @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon > 0) ?? 0)</MudText>
                </MudPaper>
            </MudItem>

            <!-- Danh sách câu hỏi -->
            <MudItem xs="12" md="8">
                <MudTabs Elevation="2" Rounded="true" PanelClass="pa-4">
                    <MudTabPanel Text="Danh sách câu hỏi">
                        <ChildContent>
                            <MudPaper Style="max-height: 425px; overflow-y: auto;" Class="pa-3">
                                @if (!DeThi.ChiTietDeThis?.Any() ?? true)
                                {
                                    <MudText Typo="Typo.body1" Class="text-center">Chưa có câu hỏi nào.</MudText>
                                }
                                else
                                {
                                    @foreach (var ct in DeThi.ChiTietDeThis.OrderBy(x => x.ThuTu))
                                    {
                                        var ch = ct.CauHoi!;
                                        <div class="mb-5 p-4" style="border:1px solid #ccc; border-radius:10px;">
                                            <div class="d-flex align-center gap-3 mb-3">
                                                <MudText Typo="Typo.h6">Câu @ct.ThuTu</MudText>

                                                @if (ch.SoCauHoiCon > 0)
                                                {
                                                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">(@ch.SoCauHoiCon câu)</MudChip>
                                                }
                                            </div>

                                            <div class="mb-3">@((MarkupString)ch.NoiDung)</div>

                                            @if (ch.CauTraLois?.Any() == true)
                                            {
                                                <div class="pl-4">
                                                    @foreach (var da in ch.CauTraLois.OrderBy(x => x.ThuTu))
                                                    {
                                                        var label = da.ThuTu switch
                                                        {
                                                            1 => "A.",
                                                            2 => "B.",
                                                            3 => "C.",
                                                            4 => "D.",
                                                            _ => $"{da.ThuTu}."
                                                        };

                                                        <div class="d-flex align-start gap-2 mb-2"
                                                             style="@(da.LaDapAn
                                                                        ? "border:2px solid #2e7d32; border-radius:8px; padding:8px 12px; background-color:#e8f5e9;"
                                                                        : "border:1px solid #ddd; border-radius:8px; padding:8px 12px;")">
                                                            <MudText Class="font-weight-bold">@label</MudText>
                                                            <MudText>@((MarkupString)da.NoiDung)</MudText>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }

                                }
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>

                    <MudTabPanel Text="Tóm tắt đề">
                        <ChildContent>
                            <MudPaper Class="pa-4" Style="height: 425px; overflow-y: auto;">
                                <MudGrid Class="mb-4">
                                    <!-- Tổng số câu hỏi -->
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Class="pa-4" Elevation="0"
                                                  Style=@($"border:1px solid {Colors.Blue.Darken3};" +
                                                        $" border-radius:12px;" +
                                                        $" background-color:{Colors.Blue.Lighten5};")>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Tổng số câu hỏi</MudText>
                                            <MudText Typo="Typo.h5" Color="Color.Primary" Class="font-weight-bold">
                                                @DeThi.SoCauHoi
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>

                                    <!-- Tổng câu hỏi đơn -->
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Class="pa-4" Elevation="0"
                                                  Style=@($"border:1px solid {Colors.Green.Darken3};" +
                                                        $" border-radius:12px;" +
                                                        $" background-color:{Colors.Green.Lighten5};")>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Success">Tổng câu hỏi đơn</MudText>
                                            <MudText Typo="Typo.h5" Color="Color.Success" Class="font-weight-bold">
                                                @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon == 0) ?? 0)
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>

                                    <!-- Tổng câu hỏi nhóm -->
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Class="pa-4" Elevation="0"
                                                  Style=@($"border:1px solid {Colors.Red.Darken3};" +
                                                        $" border-radius:12px;" +
                                                        $" background-color:{Colors.Red.Lighten5};")>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Tổng câu hỏi nhóm</MudText>
                                            <MudText Typo="Typo.h5" Color="Color.Secondary" Class="font-weight-bold">
                                                @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon > 0) ?? 0)
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>
                                </MudGrid>

                                <MudDivider Class="my-2"/>

                                <!-- Thông tin đề thi -->
                                <MudText Typo="Typo.h6" Class="mb-3 font-weight-bold" Style=@($"color:{Colors.Red.Darken3};")>Thông tin đề thi</MudText>
                                <MudText><strong>Tên đề:</strong> @DeThi.TenDeThi</MudText>
                                <MudText Class="mt-1"><strong>Môn học:</strong> @DeThi.TenMonHoc</MudText>
                                <MudText Class="mt-1"><strong>Khoa:</strong> @DeThi.TenKhoa</MudText>

                                <MudText Class="mt-3">
                                    <strong>Ngày tạo:</strong>
                                    <span Style=@($"color:{Colors.Blue.Darken3};")>
                                        @DeThi.NgayTao.ToString("dd/MM/yyyy")
                                    </span>
                                </MudText>

                                <MudText>
                                    <strong>Ngày cập nhật:</strong>
                                    <span Style=@($"color:{Colors.Red.Darken3};")>
                                        @DeThi.NgayCapNhap.ToString("dd/MM/yyyy")
                                    </span>
                                </MudText>
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    }
</MudContainer>