@page "/dethi/{MaDeThi:guid}"
@using BeQuestionBank.Shared.DTOs.DeThi
@using BEQuestionBank.Shared.DTOs.DeThi
@using FEQuestionBank.Client.Services
@using MudBlazor
@inject IDeThiApiClient DeThiApiClient
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">
            Quay lại danh sách đề thi
        </MudButton>

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Description">
                Tải Word
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf">
                Tải PDF
            </MudButton>
        </div>
    </div>

    @if (DeThi == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudGrid Spacing="4">
            <!-- Thông tin đề thi -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-3">Thông tin đề thi</MudText>
                    <MudText><strong>Tên đề:</strong> @DeThi.TenDeThi</MudText>
                    <MudText Class="mt-2"><strong>Môn học:</strong> @DeThi.TenMonHoc</MudText>
                    <MudText Class="mt-2"><strong>Khoa:</strong> @DeThi.TenKhoa</MudText>
                    <MudText Class="mt-2"><strong>Thời gian:</strong> Chưa xác định</MudText>
                    <MudText Class="mt-2"><strong>Ngày tạo:</strong> @DeThi.NgayTao.ToString("dd/MM/yyyy")</MudText>

                    <MudDivider Class="my-4" />

                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Cấu trúc phân chương:</MudText>
                    <ul class="pl-4 mt-2">
                        @if (DeThi.ChiTietDeThis?.Any() == true)
                        {
                            foreach (var ct in DeThi.ChiTietDeThis)
                            {
                                <li>Phần @(ct.ThuTu): @(ct.CauHoi?.MaSoCauHoi ?? ct.ThuTu) câu</li>
                            }
                        }
                        else
                        {
                            <li>Chưa có cấu trúc</li>
                        }
                    </ul>
                </MudPaper>

                <!-- Thống kê -->
                <MudPaper Class="pa-4 mt-4" Elevation="3">
                    <MudText Typo="Typo.h6" Class="mb-3">Thống kê câu hỏi</MudText>
                    <MudText><strong>Tổng số câu hỏi:</strong> @(DeThi.SoCauHoi)</MudText>
                    <MudText><strong>Tổng câu hỏi đơn:</strong> @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon == 0) ?? 0)</MudText>
                    <MudText><strong>Tổng câu hỏi nhóm:</strong> @(DeThi.ChiTietDeThis?.Count(c => c.CauHoi?.SoCauHoiCon > 0) ?? 0)</MudText>
                </MudPaper>
            </MudItem>

            <!-- Danh sách câu hỏi -->
            <MudItem xs="12" md="8">
                <MudTabs Elevation="2" Rounded="true" PanelClass="pa-4">
                    <MudTabPanel Text="Danh sách câu hỏi">
                        <ChildContent>
                            <MudPaper Style="max-height: 700px; overflow-y: auto;" Class="pa-3">
                                @if (!DeThi.ChiTietDeThis?.Any() ?? true)
                                {
                                    <MudText Typo="Typo.body1" Class="text-center">Chưa có câu hỏi nào.</MudText>
                                }
                                else
                                {
                                    int stt = 1;
                                    foreach (var ct in DeThi.ChiTietDeThis!)
                                    {
                                        var ch = ct.CauHoi!;
                                        <div class="mb-5 p-4 border rounded">
                                            <div class="d-flex align-center gap-3 mb-3">
                                                <MudText Typo="Typo.h6">Câu @stt</MudText>
                                                @if (ch.SoCauHoiCon > 0)
                                                {
                                                    <MudChip T="string" Color="Color.Primary" Size="Size.Small"> (@ch.SoCauHoiCon câu)</MudChip>
                                                }
                                            </div>

                                            <div class="mb-3">
                                                @((MarkupString)ch.NoiDung)
                                            </div>

                                            @if (ch.CauTraLois?.Any() == true)
                                            {
                                                <div class="pl-4">
                                                    @foreach (var da in ch.CauTraLois)
                                                    {
                                                        var label = da.ThuTu switch
                                                        {
                                                            1 => "A.",
                                                            2 => "B.",
                                                            3 => "C.",
                                                            4 => "D.",
                                                            _ => $"{da.ThuTu}."
                                                        };

                                                        <div class="d-flex align-start gap-2 mb-2">
                                                            <MudText Class="font-weight-bold">@label</MudText>
                                                            <MudText Class="@(da.LaDapAn ? "text-success font-weight-bold" : "")">
                                                                @((MarkupString)da.NoiDung)
                                                            </MudText>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        stt++;
                                    }
                                }
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>

                    <MudTabPanel Text="Tóm tắt đề">
                        <ChildContent>
                            <MudPaper Class="pa-4" Style="height: 700px; overflow-y: auto;">
                                <MudText Typo="Typo.body1">
                                    Đề thi gồm <strong>@DeThi.SoCauHoi câu hỏi</strong>.
                                </MudText>
                                <MudText Class="mt-3">
                                    Thuộc môn <strong>@DeThi.TenMonHoc</strong>, khoa <strong>@DeThi.TenKhoa</strong>.
                                </MudText>
                                <MudText Class="mt-2">
                                    Ngày tạo: <strong>@DeThi.NgayTao:dd/MM/yyyy</strong>
                                </MudText>
                                <MudText Class="mt-2">
                                    Trạng thái: <strong>@(DeThi.DaDuyet == true ? "Đã duyệt" : "Chưa duyệt")</strong>
                                </MudText>
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public Guid MaDeThi { get; set; }
    private DeThiWithChiTietAndCauTraLoiDto? DeThi;

    protected override async Task OnInitializedAsync()
    {
        var res = await DeThiApiClient.GetByIdWithChiTietAndCauTraLoiAsync(MaDeThi);
        if (res.Success && res.Data != null)
        {
            DeThi = res.Data;
        }
        else
        {
            Snackbar.Add("Không tải được đề thi!", Severity.Error);
            Nav.NavigateTo("/dethi");
        }
    }

    private void GoBack() => Nav.NavigateTo("/dethi");
}