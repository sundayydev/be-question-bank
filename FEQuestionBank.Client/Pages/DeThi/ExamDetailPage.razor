@page "/exams/{MaDeThi:guid}"
@using FEQuestionBank.Client.Services
@using FEQuestionBank.Client.Component.Other
@using MudBlazor
@inject IDeThiApiClient DeThiApiClient
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inherits DeThiDetailBase

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudBreadcrumbs Items="_breadcrumbs"/>
    <div class="d-flex justify-space-between align-center mb-4">
        <MudButton Variant="Variant.Filled" Style=@($"color:{Colors.Blue.Darken3}; border-radius:10px")
                   StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="GoBack">
            Quay lại danh sách đề thi
        </MudButton>

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled"
                       OnClick="@(() => OpenExportDialog("word"))"
                       StartIcon="@Icons.Material.Filled.Description"
                       Style=@("color:white; background-color:" + Colors.Blue.Darken3 +
                       "; border-radius:8px; height:42px; width:150px; text-transform:none;")>
                Tải Word
            </MudButton>

            <!-- Nút Tải PDF - màu đỏ -->
            <MudButton Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.PictureAsPdf"
                       OnClick="@(() => OpenExportDialog("pdf"))"
                       Style=@("color:white; background-color:" + Colors.Red.Darken3 +
                       "; border-radius:8px; height:42px; width:150px; text-transform:none; margin-left:10px;")>
                Tải PDF
            </MudButton>
        </div>
    </div>

    @if (DeThi == null)
    {
        <MudProgressCircular Style="text-align: center;align-items: center" Indeterminate="true"/>
    }
    else
    {
        <MudGrid Spacing="4">
            <!-- Thông tin đề thi -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3" Style="border-radius: 10px">
                    <MudText Typo="Typo.h6" Class="mb-3" Style=@($"color:{Colors.Red.Darken3};")>
                        Thông tin đề thi
                    </MudText>
                    <MudText><strong>Tên đề:</strong> @DeThi.TenDeThi</MudText>
                    <MudText Class="mt-2"><strong>Môn học:</strong> @DeThi.TenMonHoc</MudText>
                    <MudText Class="mt-2"><strong>Khoa:</strong> @DeThi.TenKhoa</MudText>
                    <MudText Class="mt-2"><strong>Ngày tạo:</strong> @DeThi.NgayTao.ToString("dd/MM/yyyy")</MudText>

                    <MudDivider Class="my-4"/>

                    <MudText Typo="Typo.subtitle1" Class="font-weight-bold">Cấu trúc phân chương:</MudText>
                    <ul class="pl-4 mt-2">
                        <li>Chưa có cấu trúc</li>
                    </ul>
                </MudPaper>

                <!-- Thống kê -->
                <MudPaper Class="pa-4 mt-4" Elevation="3" Style="border-radius: 10px">
                    <MudText Typo="Typo.h6" Class="mb-3">Thống kê câu hỏi</MudText>
                    <MudText><strong>Tổng số câu hỏi:</strong> @(DeThi.SoCauHoi ?? 0)</MudText>
                </MudPaper>
            </MudItem>

            <!-- Danh sách câu hỏi -->
            <MudItem xs="12" md="8">
                <MudTabs Elevation="2" Rounded="true" PanelClass="pa-4">
                    <MudTabPanel Text="Danh sách câu hỏi">
                        <ChildContent>
                            <MudPaper Style=" overflow-y: auto;" Class="pa-3">
                                @if (!DeThi.ChiTietDeThis?.Any() ?? true)
                                {
                                    <MudText Typo="Typo.body1" Class="text-center">Chưa có câu hỏi nào.</MudText>
                                }
                                else
                                {
                                    @foreach (var ct in DeThi.ChiTietDeThis.OrderBy(x => x.ThuTu))
                                    {
                                        var ch = ct.CauHoi!;
                                        <div class="mb-6 p-5"
                                             style="border:2px solid #e0e0e0; border-radius:12px; background-color:#fdfdfd;">
                                            <div class="d-flex align-center gap-3 mb-4">
                                                <MudText Typo="Typo.h6" Class="font-weight-bold">Câu @ct.ThuTu</MudText>

                                                @if (ch.SoCauHoiCon > 0)
                                                {
                                                    <MudChip T="int" Color="Color.Primary" Size="Size.Small"
                                                             Variant="Variant.Filled">
                                                        @ch.SoCauHoiCon câu
                                                    </MudChip>
                                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small"
                                                             Variant="Variant.Filled">
                                                        @ch.CLO
                                                    </MudChip>
                                                }
                                            </div>

                                            <!-- Nội dung chính của câu hỏi cha -->
                                            <div class="mb-5 pl-3 pr-3">
                                                <LatexContent Content="@ch.NoiDung"/>
                                            </div>

                                            <!-- Đáp án cho câu hỏi ĐƠN (không phải nhóm) -->
                                            @if (ch.SoCauHoiCon == 0 && ch.CauTraLois?.Any() == true)
                                            {
                                                <div class="pl-6">
                                                    @foreach (var da in ch.CauTraLois.OrderBy(x => x.ThuTu))
                                                    {
                                                        var label = da.ThuTu switch
                                                        {
                                                            1 => "A.",
                                                            2 => "B.",
                                                            3 => "C.",
                                                            4 => "D.",
                                                            _ => $"{da.ThuTu}."
                                                        };

                                                        <div class="d-flex align-start gap-3 mb-3"
                                                             style="@(da.LaDapAn
                                                                        ? "border-left:4px solid #4caf50; background-color:#e8f5e9; padding:8px 12px; border-radius:6px;"
                                                                        : "border-left:4px solid #bdbdbd; padding:8px 12px; border-radius:6px;")">
                                                            <MudText Class="font-weight-bold"
                                                                     Style="min-width:30px;">@label</MudText>

                                                            <LatexContent Content="@da.NoiDung"/>
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <!-- Câu hỏi con (cho nhóm: đọc hiểu, nối câu, ghép đôi...) -->
                                            @if (ch.SoCauHoiCon > 0 && ch.CauHoiCons?.Any() == true)
                                            {
                                                <div class="mt-4 pl-4">
                                                    @foreach (var con in ch.CauHoiCons.OrderBy(c => c.MaSoCauHoi))
                                                    {
                                                        <div class="mb-6">
                                                            <!-- Số thứ tự và nội dung câu con -->
                                                            <div class="d-flex align-start gap-3 mb-3">
                                                                <MudText Class="font-weight-bold"
                                                                         Style="color:#1976d2; min-width:50px;">
                                                                    @con.MaSoCauHoi.
                                                                </MudText>
                                                                <div class="flex-grow-1">
                                                                    <LatexContent Content="@con.NoiDung"/>
                                                                </div>
                                                            </div>

                                                            <!-- Đáp án của câu con nếu có -->
                                                            @if (con.CauTraLois?.Any() == true)
                                                            {
                                                                <div class="pl-8 mt-2">
                                                                    @foreach (var da in con.CauTraLois.OrderBy(x => x.ThuTu))
                                                                    {
                                                                        var label = da.ThuTu switch
                                                                        {
                                                                            1 => "A.",
                                                                            2 => "B.",
                                                                            3 => "C.",
                                                                            4 => "D.",
                                                                            _ => $"{da.ThuTu}."
                                                                        };

                                                                        <div class="d-flex align-start gap-3 mb-2"
                                                                             style="@(da.LaDapAn
                                                                                        ? "border-left:3px solid #4caf50; background-color:#e8f5e9; padding:6px 10px; border-radius:4px;"
                                                                                        : "border-left:3px solid #ddd; padding:6px 10px; border-radius:4px;")">
                                                                            <MudText Class="font-weight-bold"
                                                                                     Style="min-width:30px;">@label</MudText>
                                                                            <LatexContent Content="@da.NoiDung"/>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <!-- Cảnh báo chỉ khi câu hỏi thật sự trống -->
                                            @if (ch.SoCauHoiCon == 0 && (ch.CauTraLois?.Any() != true))
                                            {
                                                <MudAlert Severity="Severity.Warning" Class="mt-3">
                                                    Chưa có đáp án cho câu hỏi này
                                                </MudAlert>
                                            }
                                        </div>
                                    }
                                }
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>

                    <MudTabPanel Text="Tóm tắt đề">
                        <ChildContent>
                            <MudPaper Class="pa-4" Style="height: 420px; overflow-y: auto;">
                                <MudGrid Class="mb-4">
                                    <!-- Tổng số câu hỏi -->
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Class="pa-4" Elevation="0"
                                                  Style=@($"border:1px solid {Colors.Blue.Darken3};" +
                                                  $" border-radius:12px;" +
                                                  $" background-color:{Colors.Blue.Lighten5};")>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Tổng số câu hỏi
                                            </MudText>
                                            <MudText Typo="Typo.h5" Color="Color.Primary" Class="font-weight-bold">
                                                @(DeThi.SoCauHoi ?? 0)
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>
                                </MudGrid>

                                <MudDivider Class="my-2"/>

                                <!-- Thông tin đề thi -->
                                <MudText Typo="Typo.h6" Class="mb-3 font-weight-bold"
                                         Style=@($"color:{Colors.Red.Darken3};")>Thông tin đề thi
                                </MudText>
                                <MudText><strong>Tên đề:</strong> @DeThi.TenDeThi</MudText>
                                <MudText Class="mt-1"><strong>Môn học:</strong> @DeThi.TenMonHoc</MudText>
                                <MudText Class="mt-1"><strong>Khoa:</strong> @DeThi.TenKhoa</MudText>

                                <MudText Class="mt-3">
                                    <strong>Ngày tạo:</strong>
                                    <span Style=@($"color:{Colors.Blue.Darken3};")>
                                        @DeThi.NgayTao.ToString("dd/MM/yyyy")
                                    </span>
                                </MudText>

                                <MudText>
                                    <strong>Ngày cập nhật:</strong>
                                    <span Style=@($"color:{Colors.Red.Darken3};")>
                                        @DeThi.NgayCapNhap.ToString("dd/MM/yyyy")
                                    </span>
                                </MudText>
                            </MudPaper>
                        </ChildContent>
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    }
</MudContainer>