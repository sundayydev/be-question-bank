@using BeQuestionBank.Shared.DTOs.CauHoi
@using FEQuestionBank.Client.Pages
@using BeQuestionBank.Shared.DTOs.CauTraLoi
@using BeQuestionBank.Shared.Enums
@using FEQuestionBank.Client.Component.Other
@using FEQuestionBank.Client.Services.Interface
@namespace FEQuestionBank.Client.Components

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Quiz" Class="mr-3"/>
            Chi tiết câu hỏi
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudContainer Class="py-3">
            @if (CauHoi == null)
            {
                <MudProgressCircular Indeterminate="true"/>
            }
            else
            {
                <!-- Chip thông tin chung -->
                <MudGrid Spacing="2" Class="mb-4">
                    <MudItem xs="12">
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">
                            @GetQuestionTypeName()
                        </MudChip>
                        <MudChip T="short" Color="@GetLevelColor(CauHoi.CapDo)" Size="Size.Small" Class="ml-2">
                            Cấp độ @CauHoi.CapDo
                        </MudChip>
                        @if (CauHoi.CLO != null)
                        {
                            <MudChip T="string" Color="Color.Secondary" Size="Size.Small" Class="ml-2">
                                @CauHoi.CLO
                            </MudChip>
                        }
                        <MudChip T="short" Color="Color.Info" Size="Size.Small" Class="ml-2">
                            Đã dùng: @CauHoi.SoLanDung lần
                        </MudChip>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="mb-5"/>

                @*  1. GHÉP NỐi*@
                @if (IsPairing)
                {
                    <MudText Typo="Typo.h6" GutterBottomMargin Class="mb-3">Nội dung ghép nối:</MudText>
                    <div class="pa-4 rounded" style="background:#f8f9fa; border:1px solid #dee2e6;">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </div>

                    <MudText Typo="Typo.subtitle1" Class="mt-5 mb-3"><b>Danh sách cặp ghép:</b></MudText>

                    <MudGrid Spacing="3">
                        @foreach (var sub in CauHoi.CauHoiCons ?? Enumerable.Empty<CauHoiDto>())
                        {
                            var answer = sub.CauTraLois?.FirstOrDefault(x => x.LaDapAn);

                            <MudItem xs="12">
                                <MudPaper Class="pa-4" Elevation="1">
                                    <MudGrid>
                                        <MudItem xs="5">
                                            <LatexContent Content="@sub.NoiDung"/>
                                        </MudItem>

                                        <MudItem xs="2" Class="d-flex align-center justify-center">
                                            <MudIcon Icon="@Icons.Material.Filled.CompareArrows"
                                                     Color="Color.Secondary" Size="Size.Large"
                                            />
                                        </MudItem>

                                        <MudItem xs="5" Class="text-right">
                                            @if (answer != null)
                                            {
                                                <LatexContent Content="@answer.NoiDung"/>
                                            }
                                        </MudItem>
                                    </MudGrid>

                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                }
                @* 2. ĐIỀN TỪ  *@
                else if (IsFillBlank)
                {
                    <MudText Typo="Typo.h6" Class="mb-3">Đoạn văn cần điền:</MudText>
                    <MudPaper Class="pa-4 mb-4" Style="background:#f5f5f5;">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </MudPaper>

                    <MudText Typo="Typo.subtitle1" Class="mb-2"><b>Các từ/cụm từ cần điền:</b></MudText>
                    <MudList T="string" Dense="true">

                        @foreach (var (sub, index) in (CauHoi.CauHoiCons ?? new List<CauHoiDto>()).Select((x, i) => (x, i)))
                        {
                            var answer = sub.CauTraLois?.FirstOrDefault(x => x.LaDapAn);
                            var canShuffle = answer.HoanVi;

                            if (answer != null)
                            {
                                <MudListItem T="string">
                                    <div class="d-flex align-center">
                                        <MudChip T="short"
                                                 Color="Color.Success"
                                                 Size="Size.Small"
                                                 Class="mr-3">
                                            @(index + 1)
                                        </MudChip>

                                        <LatexContent Content="@answer.NoiDung"/>
                                        <div class="d-flex align-center ml-auto">
                                            @if (canShuffle == true)
                                            {
                                                <MudTooltip Text="Xáo trộn" Placement="Placement.Top">
                                                    <MudIcon Icon="@Icons.Material.Filled.Shuffle"
                                                             Color="Color.Primary"
                                                             Size="Size.Small"/>
                                                </MudTooltip>
                                            }
                                            else
                                            {
                                                <MudTooltip Text="Cố định" Placement="Placement.Top">
                                                    <MudIcon Icon="@Icons.Material.Filled.Lock"
                                                             Color="Color.Warning"
                                                             Size="Size.Small"/>
                                                </MudTooltip>
                                            }
                                        </div>
                                    </div>
                                </MudListItem>
                            }
                        }

                    </MudList>
                }
                @*  3. CÂU NHÓM   *@
                else if (IsGroup)
                {
                    <MudText Typo="Typo.h6" Class="mb-3">Đề bài chính:</MudText>
                    <MudPaper Class="pa-4 mb-5" Elevation="2">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </MudPaper>

                    @if (CauHoi.CauHoiCons != null && CauHoi.CauHoiCons.Any())
                    {
                        <MudText Typo="Typo.h6" Class="mb-3">
                            Câu hỏi con (@CauHoi.CauHoiCons.Count câu):
                        </MudText>

                        <MudExpansionPanels MultiExpansion="true">
                            @foreach (var subTuple in CauHoi.CauHoiCons.Select((sub, index) => (sub, index)))
                            {
                                var sub = subTuple.sub;
                                var stt = subTuple.index + 1;

                                <MudExpansionPanel>
                                    <TitleContent>
                                        <div class="d-flex align-center">
                                            <strong class="mr-2">Câu @stt:</strong>
                                            <LatexContent Content="@sub.NoiDung"/>
                                        </div>
                                    </TitleContent>

                                    <ChildContent>
                                        <div class="pa-3">
                                            @* Đánh ABCD + tô xanh đáp án đúng *@
                                            @foreach (var ansTuple in sub.CauTraLois.Select((ans, idx) => (ans, idx)))
                                            {
                                                var ans = ansTuple.ans;
                                                char letter = (char)('A' + ansTuple.idx);
                                                var canShuffle = ans.HoanVi;

                                                <div class="d-flex align-center my-2">
                                                    <MudChip T="string"
                                                             Color="@(ans.LaDapAn ? Color.Success : Color.Default)"
                                                             Class="mr-2">
                                                        @letter
                                                    </MudChip>

                                                    <LatexContent Content="@ans.NoiDung"/>
                                                    <div class="d-flex align-center ml-auto">
                                                        @if (canShuffle == true)
                                                        {
                                                            <MudTooltip Text="Xáo trộn" Placement="Placement.Top">
                                                                <MudIcon Icon="@Icons.Material.Filled.Shuffle"
                                                                         Color="Color.Primary"
                                                                         Size="Size.Small"/>
                                                            </MudTooltip>
                                                        }
                                                        else
                                                        {
                                                            <MudTooltip Text="Cố định" Placement="Placement.Top">
                                                                <MudIcon Icon="@Icons.Material.Filled.Lock"
                                                                         Color="Color.Warning"
                                                                         Size="Size.Small"/>
                                                            </MudTooltip>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </ChildContent>
                                </MudExpansionPanel>
                            }
                        </MudExpansionPanels>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-3">
                            Đây là câu hỏi <strong>tự luận</strong>. Học viên sẽ nhập văn bản hoặc nộp file.
                        </MudAlert>
                    }
                }
                @*  4. tự luận   *@
                else if (IsEssay)
                {
                    <MudText Typo="Typo.h6" Class="mb-3">Đề bài chính:</MudText>
                    <MudPaper Class="pa-4 mb-5" Elevation="2">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </MudPaper>

                    @if (CauHoi.CauHoiCons != null && CauHoi.CauHoiCons.Any())
                    {
                        <MudText Typo="Typo.h6" Class="mb-3">
                            Câu hỏi con (@CauHoi.CauHoiCons.Count câu):
                        </MudText>

                        <MudExpansionPanels MultiExpansion="true">
                            @foreach (var subTuple in CauHoi.CauHoiCons.Select((sub, index) => (sub, index)))
                            {
                                var sub = subTuple.sub;
                                var stt = subTuple.index + 1;

                                <MudExpansionPanel>
                                    <TitleContent>
                                        <div class="d-flex align-center">
                                            <strong class="mr-2">Câu @stt:</strong>
                                            <LatexContent Content="@sub.NoiDung"/>
                                        </div>
                                    </TitleContent>

                                    <ChildContent>
                                        <div class="pa-3">
                                            @* Đánh ABCD + tô xanh đáp án đúng *@
                                            @foreach (var ansTuple in sub.CauTraLois.Select((ans, idx) => (ans, idx)))
                                            {
                                                var ans = ansTuple.ans;
                                                char letter = (char)('A' + ansTuple.idx);
                                                var canShuffle = ans.HoanVi;

                                                <div class="d-flex align-center my-2">
                                                    <MudChip T="string"
                                                             Color="@(ans.LaDapAn ? Color.Success : Color.Default)"
                                                             Class="mr-2">
                                                        @letter
                                                    </MudChip>

                                                    <LatexContent Content="@ans.NoiDung"/>
                                                    <div class="d-flex align-center ml-auto">
                                                        @if (canShuffle == true)
                                                        {
                                                            <MudTooltip Text="Xáo trộn" Placement="Placement.Top">
                                                                <MudIcon Icon="@Icons.Material.Filled.Shuffle"
                                                                         Color="Color.Primary"
                                                                         Size="Size.Small"/>
                                                            </MudTooltip>
                                                        }
                                                        else
                                                        {
                                                            <MudTooltip Text="Cố định" Placement="Placement.Top">
                                                                <MudIcon Icon="@Icons.Material.Filled.Lock"
                                                                         Color="Color.Warning"
                                                                         Size="Size.Small"/>
                                                            </MudTooltip>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </ChildContent>
                                </MudExpansionPanel>
                            }
                        </MudExpansionPanels>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-3">
                            Đây là câu hỏi <strong>tự luận</strong>. Học viên sẽ nhập văn bản hoặc nộp file.
                        </MudAlert>
                    }
                }
                @*  5 multi *@
                else if (IsMulti)
                {
                    <MudText Typo="Typo.h6" Class="mb-3"> Trắc nghiệm nhiều đáp án</MudText>

                    <MudPaper Class="pa-4 mb-5" Elevation="2">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </MudPaper>

                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        <b>
                            Đáp án (@((CauHoi.CauTraLois ?? Enumerable.Empty<CauTraLoiDto>()).Count(x => x.LaDapAn)) đáp
                            án đúng):
                        </b>
                    </MudText>

                    @* Nếu không có đáp án thì show alert *@
                    @if (CauHoi.CauTraLois == null || !CauHoi.CauTraLois.Any())
                    {
                        <MudAlert Severity="Severity.Warning">
                            Không có đáp án nào được đính kèm cho câu hỏi này.
                        </MudAlert>
                    }
                    else
                    {
                        @foreach (var ansTuple in (CauHoi.CauTraLois ?? Enumerable.Empty<CauTraLoiDto>()).Select((ans, idx) => (ans, idx)))
                        {
                            var ans = ansTuple.ans;
                            var canShuffle = ans?.HoanVi;
                            char letter = (char)('A' + ansTuple.idx);

                            <MudPaper Class="pa-3 mb-2 d-flex align-center"
                                      Style="@(ans?.LaDapAn == true
                                                 ? "border:2px solid #4caf50; background:#e8f5e9; border-radius:8px;"
                                                 : "border:1px solid #ccc; border-radius:8px;")">

                                <MudChip T="string"
                                         Color="@(ans?.LaDapAn == true ? Color.Success : Color.Default)"
                                         Class="mr-3">
                                    @letter
                                </MudChip>

                                <div class="flex-grow-1 d-flex align-center">
                                    <LatexContent Content="@ans?.NoiDung"/>

                                    <div class="d-flex align-center ml-auto">
                                        @if (ans?.LaDapAn == true)
                                        {
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="Color.Success"
                                                     Class="mr-2">
                                                Đáp án đúng
                                            </MudChip>
                                        }

                                        @if (canShuffle == true)
                                        {
                                            <MudTooltip Text="Xáo trộn" Placement="Placement.Top">
                                                <MudIcon Icon="@Icons.Material.Filled.Shuffle"
                                                         Color="Color.Primary"
                                                         Size="Size.Small"/>
                                            </MudTooltip>
                                        }
                                        else
                                        {
                                            <MudTooltip Text="Cố định" Placement="Placement.Top">
                                                <MudIcon Icon="@Icons.Material.Filled.Lock"
                                                         Color="Color.Warning"
                                                         Size="Size.Small"/>
                                            </MudTooltip>
                                        }
                                    </div>
                                </div>
                            </MudPaper>
                        }
                    }
                }
                @* 4. TRẮC NGHIỆM ĐƠN*@
                else
                {
                    <MudText Typo="Typo.h6" Class="mb-3"> Trắc nghiệm đơn đáp án</MudText>

                    <MudPaper Class="pa-4 mb-5" Elevation="2">
                        <LatexContent Content="@CauHoi.NoiDung"/>
                    </MudPaper>

                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        <b>
                            Đáp án (@((CauHoi.CauTraLois ?? Enumerable.Empty<CauTraLoiDto>()).Count(x => x.LaDapAn)) đáp
                            án đúng):
                        </b>
                    </MudText>

                    @* Nếu không có đáp án thì show alert *@
                    @if (CauHoi.CauTraLois == null || !CauHoi.CauTraLois.Any())
                    {
                        <MudAlert Severity="Severity.Warning">
                            Không có đáp án nào được đính kèm cho câu hỏi này.
                        </MudAlert>
                    }
                    else
                    {
                        @foreach (var ansTuple in (CauHoi.CauTraLois ?? Enumerable.Empty<CauTraLoiDto>()).Select((ans, idx) => (ans, idx)))
                        {
                            var ans = ansTuple.ans;
                            var canShuffle = ans?.HoanVi;
                            char letter = (char)('A' + ansTuple.idx);

                            <MudPaper Class="pa-3 mb-2 d-flex align-center"
                                      Style="@(ans?.LaDapAn == true
                                                 ? "border:2px solid #4caf50; background:#e8f5e9; border-radius:8px;"
                                                 : "border:1px solid #ccc; border-radius:8px;")">

                                <MudChip T="string"
                                         Color="@(ans?.LaDapAn == true ? Color.Success : Color.Default)"
                                         Class="mr-3">
                                    @letter
                                </MudChip>

                                <div class="flex-grow-1 d-flex align-center">
                                    <LatexContent Content="@ans?.NoiDung"/>

                                    <div class="d-flex align-center ml-auto">
                                        @if (ans?.LaDapAn == true)
                                        {
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="Color.Success"
                                                     Class="mr-2">
                                                Đáp án đúng
                                            </MudChip>
                                        }

                                        @if (canShuffle == true)
                                        {
                                            <MudTooltip Text="Xáo trộn" Placement="Placement.Top">
                                                <MudIcon Icon="@Icons.Material.Filled.Shuffle"
                                                         Color="Color.Primary"
                                                         Size="Size.Small"/>
                                            </MudTooltip>
                                        }
                                        else
                                        {
                                            <MudTooltip Text="Cố định" Placement="Placement.Top">
                                                <MudIcon Icon="@Icons.Material.Filled.Lock"
                                                         Color="Color.Warning"
                                                         Size="Size.Small"/>
                                            </MudTooltip>
                                        }
                                    </div>
                                </div>
                            </MudPaper>
                        }
                    }
                }
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Close">Đóng</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public CauHoiDto CauHoi { get; set; } = new();

    [Parameter] public string ViewType { get; set; } = "Single"; // SingleMulti | Fill | Pairing | GroupEssay

    private int? _dummy; // để MudRadioGroup không báo lỗi khi không bind
    private EnumCLO? CloValue { get; set; }
    private bool IsPairing => ViewType == "Pairing";
    private bool IsFillBlank => ViewType == "Fill";
    private bool IsGroup => ViewType == "Group";
    private bool IsEssay => ViewType == "Essay";
    private bool IsMulti => ViewType == "Multi";

    private string GetQuestionTypeName() => ViewType switch
    {
        "Pairing" => "Ghép nối",
        "Fill" => "Điền từ / Điền chỗ trống",
        "Group" => "Câu hỏi nhóm",
        "Essay" => "Tự luận",
        "Single" => "Trắc nghiệm đơn đáp án",
        "Multi" => "Trắc nghiệm nhiều đáp án",
        _ => null
    };

    private Color GetLevelColor(short level) => level switch
    {
        <= 2 => Color.Success,
        <= 4 => Color.Warning,
        _ => Color.Error
    };

    private void Close() => MudDialog.Close();
}