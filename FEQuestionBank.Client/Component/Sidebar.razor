<MudDrawer @bind-Open="Open"
           Elevation="1"
           Variant="@DrawerVariant.Responsive"
           >
    <!-- Logo -->
    <MudDrawerHeader Style="min-height: 80px;">
        <div style="text-align: center; padding: 2px;">
            <img src="/images/LogoHutechFull.png" alt="HUTECH Logo" style="max-width: 100%; height: 60px;"/>
        </div>
    </MudDrawerHeader>
    
    <!-- Scrollable Navigation Menu -->
    <div style="overflow-y: auto; overflow-x: hidden;padding-bottom: 20px;">
        <MudNavMenu Color="Color.Info">
            <!-- Trang chủ -->
            <MudNavLink Href="/" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Home" Class="custom-link"
                        OnClick="HandleClose">Trang chủ
            </MudNavLink>

            <!-- Dashboard -->
            <MudNavLink Href="/dashboard" Icon="@Icons.Material.Filled.Dashboard" OnClick="HandleClose">Dashboard
            </MudNavLink>

            <!-- Quản lý đề -->
            <MudNavGroup Title="Quản lý đề" 
                         Icon="@Icons.Material.Filled.List" 
                         Expanded="@_group0Expanded"
                         ExpandedChanged="@((bool value) => OnGroupExpandedChanged(0, value))">
                <MudNavLink Href="/khoa" Icon="@Icons.Material.Filled.CorporateFare" OnClick="HandleClose">Danh sách khoa
                </MudNavLink>
                <MudNavLink Href="/monhoc" Icon="@Icons.Material.Filled.MenuBook" OnClick="HandleClose">Danh sách môn học
                </MudNavLink>
                <MudNavLink Href="/exams" Icon="@Icons.Material.Filled.Assignment" OnClick="HandleClose">Danh sách đề thi
                </MudNavLink>
            </MudNavGroup>

            <!-- Quản lý câu hỏi -->
            <MudNavGroup Title="Quản lý câu hỏi" 
                         Icon="@Icons.Material.Filled.QuestionAnswer" 
                         Expanded="@_group1Expanded"
                         ExpandedChanged="@((bool value) => OnGroupExpandedChanged(1, value))">
                <MudNavLink Href="/question/list" Icon="@Icons.Material.Filled.List" OnClick="HandleClose">Danh sách câu
                    hỏi
                </MudNavLink>
                <MudNavLink Href="/question/create-question" Icon="@Icons.Material.Filled.Add" OnClick="HandleClose">Thêm
                    câu hỏi
                </MudNavLink>
                <MudNavLink Href="/question/upload" Icon="@Icons.Material.Filled.Upload" OnClick="HandleClose">Tải câu hỏi
                    lên
                </MudNavLink>
                <MudNavLink Href="/trash" Icon="@Icons.Material.Filled.Delete" OnClick="HandleClose">Rác</MudNavLink>
            </MudNavGroup>

            <!-- Quản lý người dùng -->
            <MudNavGroup Title="Quản lý người dùng" 
                         Icon="@Icons.Material.Filled.Person" 
                         Expanded="@_group2Expanded"
                         ExpandedChanged="@((bool value) => OnGroupExpandedChanged(2, value))">
                <MudNavLink Href="/user/list" Icon="@Icons.Material.Filled.List" OnClick="HandleClose">Danh sách người
                    dùng
                </MudNavLink>
                <MudNavLink Href="/user/create-user" Icon="@Icons.Material.Filled.PersonAdd" OnClick="HandleClose">Thêm
                    người dùng
                </MudNavLink>
            </MudNavGroup>

            <!-- Quản lý Audio -->
            <MudNavLink Href="/manage-audio" Icon="@Icons.Material.Filled.Audiotrack" OnClick="HandleClose">Quản lý
                Audio
            </MudNavLink>

            <!-- Công cụ -->
            <MudNavGroup Title="Công cụ" 
                         Icon="@Icons.Material.Filled.Build" 
                         Expanded="@_group3Expanded"
                         ExpandedChanged="@((bool value) => OnGroupExpandedChanged(3, value))">
                <MudNavLink Href="/tools/exam-extract" Icon="@Icons.Material.Filled.ContentPaste" OnClick="HandleClose">Rút
                    trích đề thi
                </MudNavLink>
                <MudNavLink Href="/tools/extract-history" Icon="@Icons.Material.Filled.History" OnClick="HandleClose">Lịch
                    sử rút trích
                </MudNavLink>
                <MudNavLink Href="/tools/tool-images-base" Icon="@Icons.Material.Filled.InsertPhoto" OnClick="HandleClose">
                    Chuyển đổi ảnh
                </MudNavLink>
                <MudNavLink Href="/tools/tool-latex-converter" Icon="@Icons.Material.Filled.AutoMode" OnClick="HandleClose">
                    Chuyển đổi latex
                </MudNavLink>
            </MudNavGroup>

            <!-- Trợ giúp -->
            <MudNavLink Href="/help" Icon="@Icons.Material.Filled.Help" OnClick="HandleClose">Trợ giúp</MudNavLink>
        </MudNavMenu>
    </div>
</MudDrawer>

@code {
    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }

    // Biến để theo dõi trạng thái mở/đóng của từng group
    private bool _group0Expanded = false;  // Quản lý đề
    private bool _group1Expanded = true;   // Quản lý câu hỏi (mặc định mở)
    private bool _group2Expanded = false;  // Quản lý người dùng
    private bool _group3Expanded = false;  // Công cụ

    private void HandleClose()
    {
        Console.WriteLine("HandleClose called, closing drawer...");
        OnClose.InvokeAsync(false);
    }

    // Xử lý khi một group được mở/đóng
    private void OnGroupExpandedChanged(int groupIndex, bool isExpanded)
    {
        Console.WriteLine($"Group {groupIndex} expanded changed to: {isExpanded}");
        
        // Cập nhật trạng thái của group hiện tại
        switch (groupIndex)
        {
            case 0: _group0Expanded = isExpanded; break;
            case 1: _group1Expanded = isExpanded; break;
            case 2: _group2Expanded = isExpanded; break;
            case 3: _group3Expanded = isExpanded; break;
        }
        
        if (isExpanded)
        {
            // Đóng tất cả các group khác khi một group được mở
            CloseAllGroupsExcept(groupIndex);
        }
    }

    // Đóng tất cả các group trừ group được chỉ định
    private void CloseAllGroupsExcept(int exceptGroupIndex)
    {
        if (exceptGroupIndex != 0) _group0Expanded = false;
        if (exceptGroupIndex != 1) _group1Expanded = false;
        if (exceptGroupIndex != 2) _group2Expanded = false;
        if (exceptGroupIndex != 3) _group3Expanded = false;
        
        StateHasChanged();
    }
}
