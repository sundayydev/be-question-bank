
@using FEQuestionBank.Client.Component.Other
@using FEQuestionBank.Client.Pages.CauHoi
<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true" Class=" pairing-preview">
    <TitleContent>
        <div class="d-flex align-center gap-2 px-1 pt-1 pb-0">
            <MudIcon Icon="@Icons.Material.Filled.Link" Class="mr-1" Color="Color.Primary"/>
            <MudText Typo="Typo.h6" Class="font-weight-bold text-neutral">Xem trước câu hỏi ghép nối</MudText>
        </div>
    </TitleContent>

    <DialogContent>
        <MudContainer Style="max-height:80vh;" Class="py-4">

            <!-- HEADER: Hướng dẫn + Thông tin phân loại -->
            <MudPaper Class="pa-5 mb-5 rounded-lg info-banner" Elevation="1">
                <MudGrid Spacing="2" Class="info-grid">
                    <MudItem xs="12" sm="6" lg="3">
                        <MudText Typo="Typo.body1" Class="d-flex align-center gap-1">
                            <MudIcon Icon="@Icons.Material.Filled.Bookmarks" Color="Color.Default" Size="Size.Small"/>
                            <span class="label">Chương:</span><span>@TenPhan</span>
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" lg="3">
                        <MudText Typo="Typo.body1" Class="d-flex align-center gap-1">
                            <MudIcon Icon="@Icons.Material.Filled.Flag" Color="Color.Default" Size="Size.Small"/>
                            <span class="label">CLO:</span>
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary"
                                     Class="ml-1 px-2 py-0">
                                @CloName
                            </MudChip>
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" lg="3">
                        <MudText Typo="Typo.body1" Class="d-flex align-center gap-1">
                            <MudIcon Icon="@Icons.Material.Filled.Stairs" Color="Color.Default" Size="Size.Small"/>
                            <span class="label">Cấp độ:</span><span>@CapDoText</span>
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" lg="3">
                        <MudText Typo="Typo.body1" Class="d-flex align-center gap-1">
                            <MudIcon Icon="@Icons.Material.Filled.Sync" Color="Color.Default" Size="Size.Small"/>
                            <span class="label">Hoán vị:</span><span>@(HoanVi ? "Có" : "Không")</span>
                        </MudText>
                    </MudItem>
                </MudGrid>
                <MudText Typo="Typo.subtitle1" Class="font-weight-bold mb-3 text-neutral">Nội dung</MudText>
                <MudText Typo="Typo.body1" Class="mb-4 text-neutral">
                    @if (string.IsNullOrWhiteSpace(NoiDungCha))
                    {
                        <span>Chưa có nội dung</span>
                    }
                    else
                    {
                        <LatexContent Content="@NoiDungCha"/>
                    }
                </MudText>


            </MudPaper>

            <div class="preview-info-alert">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" Color="Color.Primary"
                         Style="vertical-align: middle;"/>
                Các thẻ cùng màu và số là một cặp
            </div>

            <!-- 2 CỘT GHÉP NỐI -->
            <MudPaper Class="pa-3 rounded-lg mb-4 mt-3" Elevation="1" Style="background:#ffffff;">
                <MudGrid Spacing="4" Class="mt-1">

                    <!-- CỘT TRÁI -->
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="text-center mb-3 font-weight-bold text-neutral">CỘT A
                        </MudText>

                        @foreach (var (pair, i) in Pairs.Select((p, idx) => (p, idx)))
                        {
                            var color = Colors[i % Colors.Length];
                            <MudPaper Class="pa-4 mb-3 rounded-md shadow-none fixed-cell"
                                      Style="@($"border: 1px solid {color}; background: #fff;")">
                                <div class="d-flex align-center gap-2">
                                    <MudChip T="string" Color="Color.Default" Variant="Variant.Filled"
                                             Style="@($"background:{color}; color:#fff; min-width:44px; justify-content:center;")">
                                        A@(i + 1)
                                    </MudChip>
                                    <div class="cell-content text-neutral">
                                        <LatexContent Content="@pair.Question"/>
                                    </div>
                                </div>
                            </MudPaper>
                        }
                    </MudItem>

                    <!-- CỘT PHẢI -->
                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="text-center mb-3 font-weight-bold text-neutral">CỘT B
                        </MudText>

                        @foreach (var (pair, i) in Pairs.Select((p, idx) => (p, idx)))
                        {
                            var color = Colors[i % Colors.Length];
                            <MudPaper Class="pa-4 mb-3 rounded-md shadow-none fixed-cell"
                                      Style="@($"border: 1px solid {color}; background: #fff;")">
                                <div class="d-flex align-center gap-2">
                                    <MudChip T="string" Color="Color.Default" Variant="Variant.Filled"
                                             Style="@($"background:{color}; color:#fff; min-width:44px; justify-content:center;")">
                                        B@(i + 1)
                                    </MudChip>
                                    <div class="cell-content text-neutral">
                                        <LatexContent Content="@pair.Answer"/>
                                    </div>
                                </div>
                            </MudPaper>
                        }
                    </MudItem>

                </MudGrid>
            </MudPaper>

            <!-- THÔNG BÁO -->
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                <strong>@Pairs.Count cặp ghép nối</strong> • Khi thi, đáp án sẽ được xáo trộn ngẫu nhiên
            </MudAlert>
        </MudContainer>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Primary">
            Sửa lại
        </MudButton>
        <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="Submit"
                   StartIcon="@Icons.Material.Filled.SaveAlt">
            Xác nhận lưu
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public List<CreatePairingQuestionBase.PairItem> Pairs { get; set; } = new();
    [Parameter] public string NoiDungCha { get; set; }
    [Parameter] public string TenPhan { get; set; } = "Chưa chọn";
    [Parameter] public string CloName { get; set; } = "N/A";
    [Parameter] public short CapDo { get; set; } = 2;
    [Parameter] public bool HoanVi { get; set; } = true;

    private string CapDoText => CapDo switch
    {
        1 => "1 - Nhận biết",
        2 => "2 - Thông hiểu",
        3 => "3 - Vận dụng",
        4 => "4 - Vận dụng cao",
        _ => "Chưa xác định"
    };

    private readonly string[] Colors = new[]
    {
        "#A5D8FF", // Pastel Blue
        "#FFADAD", // Pastel Red
        "#FFD6A5", // Pastel Orange
        "#FDFFB6", // Pastel Yellow
        "#CAFFBF", // Pastel Green
        "#BDB2FF", // Pastel Purple
        "#FFC6FF", // Pastel Pink
        "#9BF6FF", // Pastel Cyan
    };

    private void Cancel() => MudDialog.Cancel();
    private void Submit() => MudDialog.Close(DialogResult.Ok(true));
}

<style>
    .pairing-preview .text-neutral {
        color: #1f2937;
    }

    .info-banner {
        background: #f8fafc;
        color: #111827;
        border: 1px solid #e5e7eb;
        box-shadow: none;
    }

    .info-grid .label {
        font-weight: 600;
        margin-right: 0.2rem;
    }

    .preview-info-alert {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.85rem 1rem;
        color: #1f2937;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .fixed-cell {
        display: flex;
        align-items: center;
        min-height: 56px;
    }

    .cell-content {
        flex: 1;
        word-break: break-word;
        line-height: 1.5;
    }
</style>