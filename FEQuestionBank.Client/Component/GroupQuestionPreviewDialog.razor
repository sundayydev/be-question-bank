@using BeQuestionBank.Shared.DTOs.CauHoi
@using FEQuestionBank.Client.Pages.CauHoi
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 750px; overflow-y: auto; padding: 0;">
            <!-- Thông tin phân loại -->
            <MudPaper Elevation="0" Class="mb-4 p-3 bg-grey-lighten-4 rounded-lg border-1 border-grey-lighten-2">
                <MudText Typo="Typo.subtitle2" Class="mb-2 font-bold text-uppercase text-secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                    Thông tin phân loại
                </MudText>
                <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap; gap: 8px;">
                    @if (!string.IsNullOrEmpty(TenKhoa))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" Class="mr-1" />
                            @TenKhoa
                        </MudChip>
                    }
                    @if (!string.IsNullOrEmpty(TenMon))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" Class="mr-1" />
                            @TenMon
                        </MudChip>
                    }
                    @if (!string.IsNullOrEmpty(TenPhan))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1" />
                            @TenPhan
                        </MudChip>
                    }
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                        CLO: @CloName
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                        <MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Size="Size.Small" Class="mr-1" />
                        @ChildQuestions.Count câu hỏi con
                    </MudChip>
                </MudStack>
            </MudPaper>

            <!-- Nội dung đoạn văn cha -->
            <MudPaper Elevation="0" Class="p-4 mb-4 bg-blue-lighten-5 rounded-lg border-l-4 border-primary">
                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-1 d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-2" />
                    <b>Nội dung đoạn văn / Ngữ cảnh chung:</b>
                </MudText>
                <MudDivider Class="mb-3" />
                <LatexContent Content="@ParentContent" Class="question-latex-preview"/>
            </MudPaper>

            <!-- Danh sách câu hỏi con -->
            <MudText Typo="Typo.h6" Class="mb-3 ml-1 font-bold d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.QuestionAnswer" Size="Size.Medium" Class="mr-2" Color="Color.Primary" />
                Các câu hỏi con:
            </MudText>

            <MudStack Spacing="3">
                @for (int qIndex = 0; qIndex < ChildQuestions.Count; qIndex++)
                {
                    var question = ChildQuestions[qIndex];
                    var questionNumber = qIndex + 1;

                    <MudPaper Elevation="1" Class="p-4 rounded-lg question-card">
                        <!-- Header câu hỏi -->
                        <div class="d-flex align-center mb-3 pb-2 border-bottom-1 border-grey-lighten-3">
                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-3">
                                @questionNumber
                            </MudAvatar>
                            <div class="flex-grow-1">
                                <MudText Typo="Typo.caption" Class="text-secondary">Câu hỏi @questionNumber</MudText>
                                <div class="font-bold" style="color: #1976d2;">
                                    <LatexContent Content="@question.Content"/>
                                </div>
                                @if (question.CLO.HasValue)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text" Class="mt-1 pl-0">
                                        CLO riêng: @question.CLO.Value.ToString()
                                    </MudChip>
                                }
                            </div>
                        </div>

                        <!-- Danh sách đáp án -->
                        <MudText Typo="Typo.caption" Class="mb-2 ml-1 font-bold text-secondary">Các lựa chọn:</MudText>
                        <MudGrid Spacing="2">
                            @for (int aIndex = 0; aIndex < question.Answers.Count; aIndex++)
                            {
                                var ans = question.Answers[aIndex];
                                var label = (char)('A' + aIndex);

                                <MudItem xs="12" sm="6">
                                    <MudPaper Class="@($"p-3 d-flex align-center transition-all {(ans.IsCorrect ? "answer-correct" : "answer-normal")}")"
                                              Elevation="0">
                                        <MudAvatar Color="@(ans.IsCorrect ? Color.Success : Color.Default)"
                                                   Variant="@(ans.IsCorrect ? Variant.Filled : Variant.Outlined)"
                                                   Size="Size.Medium"
                                                   Class="mr-3 font-bold">
                                            @label
                                        </MudAvatar>

                                        <div class="flex-grow-1 answer-latex-content" style="@(ans.IsCorrect ? "font-weight: 500;" : "")">
                                            <LatexContent Content="@ans.Text"/>
                                        </div>

                                        @if (ans.IsCorrect)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled" Class="ml-2">
                                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                            </MudChip>
                                        }
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudPaper>
                }
            </MudStack>

            @if (ChildQuestions.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Class="mt-3">
                    Chưa có câu hỏi con nào được thêm vào.
                </MudAlert>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel" Color="Color.Secondary">
            <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Class="mr-1" />
            Đóng
        </MudButton>
        <MudButton Variant="Variant.Filled" OnClick="Submit" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save">
            Lưu ngay
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    .answer-correct {
        background-color: #e6ffed;      /* xanh lá nhạt */
        border: 1px solid #4caf50;      /* xanh lá đậm */
        color: #2e7d32;                 /* chữ xanh đậm */
        border-radius: 8px;
        box-shadow: 0px 2px 4px rgba(76, 175, 80, 0.15);
    }

    .answer-normal {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #fafafa;
    }

        .answer-normal:hover {
            background-color: #f5f5f5;
        }

    .transition-all {
        transition: all 0.3s ease;
    }

    .question-card {
        border: 1px solid #e3f2fd;
        background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
        transition: all 0.2s ease;
    }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

    .border-bottom-1 {
        border-bottom: 1px solid;
    }
</style>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string ParentContent { get; set; } = "";
    [Parameter] public List<CreateGroupQuestionBase.ChildQuestionModel> ChildQuestions { get; set; } = new();

    // Metadata
    [Parameter] public string TenKhoa { get; set; } = "";
    [Parameter] public string TenMon { get; set; } = "";
    [Parameter] public string TenPhan { get; set; } = "";
    [Parameter] public string CloName { get; set; } = "";

    void Cancel() => MudDialog.Cancel();
    void Submit() => MudDialog.Close(DialogResult.Ok(true));
}